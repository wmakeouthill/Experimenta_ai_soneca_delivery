<div class="delivery-container"
    [class.auth-page]="etapaAtual() === 'boas-vindas' || etapaAtual() === 'login' || etapaAtual() === 'cadastro'">

    <!-- ========== BLOQUEIO: LOJA FECHADA OU PAUSADA ========== -->
    @if (statusLoja() !== 'ABERTA') {
    <div class="bloqueio-screen">
        <div class="bloqueio-content">
            @if (verificandoStatusLoja()) {
            <!-- Verificando status -->
            <div class="bloqueio-loading">
                <div class="loading-spinner"></div>
                <p>Verificando disponibilidade...</p>
            </div>
            } @else if (statusLoja() === 'FECHADA') {
            <!-- Loja fechada -->
            <div class="bloqueio-icon">üè™</div>
            <h1 class="bloqueio-titulo">Loja Fechada</h1>
            <p class="bloqueio-mensagem">{{ mensagemStatusLoja() || 'Estamos fechados no momento. Volte em breve!' }}
            </p>
            <div class="bloqueio-info">
                <span>üïê</span>
                <span>Fique atento aos nossos hor√°rios de funcionamento</span>
            </div>
            } @else if (statusLoja() === 'PAUSADA') {
            <!-- Loja pausada temporariamente -->
            <div class="bloqueio-icon">‚è∏Ô∏è</div>
            <h1 class="bloqueio-titulo">Temporariamente Indispon√≠vel</h1>
            <p class="bloqueio-mensagem">{{ mensagemStatusLoja() || 'Estamos com alta demanda no momento. Por favor,
                tente novamente em alguns minutos.' }}</p>
            <div class="bloqueio-info">
                <span>‚è≥</span>
                <span>Voltamos em breve!</span>
            </div>
            }
            <button class="btn-primary btn-large" (click)="verificarStatusLoja()">
                üîÑ Verificar novamente
            </button>
        </div>
    </div>
    } @else {

    <!-- PWA Install Banner -->
    @if (mostrarBannerPwa()) {
    <div class="pwa-install-banner">
        <div class="pwa-install-texto">
            <strong>Instale o app</strong>
            <span>Atalho na tela inicial, experi√™ncia fullscreen e mais r√°pida.</span>
        </div>
        <div class="pwa-install-botoes">
            <button class="pwa-btn-secundario" (click)="fecharBannerPwa()">Agora n√£o</button>
            <button class="pwa-btn-primario" (click)="instalarPwa()">Instalar</button>
        </div>
    </div>
    }

    <!-- Erro Global -->
    @if (erro()) {
    <div class="error-toast">
        <span>‚ö†Ô∏è {{ erro() }}</span>
        <button (click)="erro.set(null)">‚úï</button>
    </div>
    }

    <!-- ========== BOAS-VINDAS ========== -->
    @if (etapaAtual() === 'boas-vindas') {
    <div class="auth-screen">
        <div class="auth-header">
            <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-grande">
            <h1>Soneca Delivery</h1>
            <p class="subtitulo">Pe√ßa seu lanche favorito e receba em casa!</p>
        </div>

        <div class="auth-content">
            <div class="auth-buttons">
                <button class="btn-primary btn-large" (click)="irParaLogin()">
                    J√° tenho conta
                </button>
                <button class="btn-secondary btn-large" (click)="irParaCadastro()">
                    Criar minha conta
                </button>
            </div>

            <div class="divider">
                <span>ou continue com</span>
            </div>

            <div #googleButtonBoasVindas class="google-button-container"></div>
        </div>

        <div class="auth-footer">
            <p>Ao continuar, voc√™ concorda com nossos <a href="/termos-uso">Termos de Uso</a> e <a
                    href="/politica-privacidade">Pol√≠tica de Privacidade</a></p>
        </div>
    </div>
    }

    <!-- ========== LOGIN ========== -->
    @if (etapaAtual() === 'login') {
    <div class="auth-screen">
        <button class="btn-back" (click)="irParaBoasVindas()">‚Üê Voltar</button>

        <div class="auth-header compact">
            <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-media">
            <h1>Entrar</h1>
        </div>

        <div class="auth-content">
            <form class="auth-form" (ngSubmit)="fazerLogin()">
                <div class="form-group">
                    <label for="login-telefone">Telefone</label>
                    <input type="tel" id="login-telefone" [value]="loginTelefone()"
                        (input)="onLoginTelefoneChange($event)" placeholder="(00) 00000-0000" maxlength="15"
                        inputmode="numeric" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label for="login-senha">Senha</label>
                    <input type="password" id="login-senha" [ngModel]="loginSenha()"
                        (ngModelChange)="loginSenha.set($event)" placeholder="Sua senha" minlength="6"
                        autocomplete="current-password">
                </div>

                <button type="submit" class="btn-primary btn-large" [disabled]="!loginValido() || loginCarregando()">
                    @if (loginCarregando()) {
                    <span class="spinner"></span> Entrando...
                    } @else {
                    Entrar
                    }
                </button>
            </form>

            <div class="divider">
                <span>ou</span>
            </div>

            <div #googleButtonLogin class="google-button-container"></div>

            <p class="auth-link">
                N√£o tem conta? <a (click)="irParaCadastro()">Cadastre-se</a>
            </p>
        </div>
    </div>
    }

    <!-- ========== CADASTRO ========== -->
    @if (etapaAtual() === 'cadastro') {
    <div class="auth-screen">
        @if (etapaCadastro() === 'dados') {
        <button class="btn-back" (click)="irParaBoasVindas()">‚Üê Voltar</button>
        } @else {
        <button class="btn-back" (click)="voltarParaDados()">‚Üê Voltar</button>
        }

        <div class="auth-header compact">
            <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-media">
            <h1>@if (cliente()) { Complete seu cadastro } @else { Criar conta }</h1>
        </div>

        <div class="progress-steps">
            <div class="step" [class.active]="etapaCadastro() === 'dados'"
                [class.completed]="etapaCadastro() === 'endereco'">
                <span class="step-number">1</span>
                <span class="step-label">Dados</span>
            </div>
            <div class="step-line" [class.active]="etapaCadastro() === 'endereco'"></div>
            <div class="step" [class.active]="etapaCadastro() === 'endereco'">
                <span class="step-number">2</span>
                <span class="step-label">Endere√ßo</span>
            </div>
        </div>

        <div class="auth-content">
            <!-- Etapa 1: Dados Pessoais -->
            @if (etapaCadastro() === 'dados' && !cliente()) {
            <form class="auth-form" (ngSubmit)="avancarParaEndereco()">
                <div class="form-group">
                    <label for="cad-nome">Nome completo *</label>
                    <input type="text" id="cad-nome" [ngModel]="formCadastro().nome"
                        (ngModelChange)="atualizarFormCadastro('nome', $event)" placeholder="Seu nome" maxlength="200"
                        autocomplete="name">
                </div>

                <div class="form-group">
                    <label for="cad-telefone">Telefone *</label>
                    <input type="tel" id="cad-telefone" [value]="formCadastro().telefone"
                        (input)="onCadastroTelefoneChange($event)" placeholder="(00) 00000-0000" maxlength="15"
                        inputmode="numeric" autocomplete="tel">
                </div>

                <div class="form-group">
                    <label for="cad-email">Email (opcional)</label>
                    <input type="email" id="cad-email" [ngModel]="formCadastro().email"
                        (ngModelChange)="atualizarFormCadastro('email', $event)" placeholder="seu@email.com"
                        autocomplete="email">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cad-senha">Senha *</label>
                        <input type="password" id="cad-senha" [ngModel]="formCadastro().senha"
                            (ngModelChange)="atualizarFormCadastro('senha', $event)" placeholder="M√≠nimo 6 caracteres"
                            minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="cad-confirmar-senha">Confirmar *</label>
                        <input type="password" id="cad-confirmar-senha" [ngModel]="formCadastro().confirmarSenha"
                            (ngModelChange)="atualizarFormCadastro('confirmarSenha', $event)"
                            placeholder="Repita a senha" minlength="6" autocomplete="new-password">
                    </div>
                </div>

                @if (formCadastro().senha && formCadastro().confirmarSenha && formCadastro().senha !==
                formCadastro().confirmarSenha) {
                <p class="error-text">As senhas n√£o coincidem</p>
                }

                <button type="submit" class="btn-primary btn-large" [disabled]="!dadosCadastroValidos()">
                    Continuar ‚Üí
                </button>
            </form>

            <div class="divider">
                <span>ou cadastre-se com</span>
            </div>

            <div #googleButtonCadastro class="google-button-container"></div>

            <p class="auth-link">
                J√° tem conta? <a (click)="irParaLogin()">Entrar</a>
            </p>
            }

            <!-- Etapa 2: Endere√ßo -->
            @if (etapaCadastro() === 'endereco') {
            <form class="auth-form" (ngSubmit)="finalizarCadastro()">
                <div class="form-group">
                    <label for="cad-cep">CEP *</label>
                    <div class="input-with-loading">
                        <input type="text" id="cad-cep" [value]="formCadastro().cep" (input)="onCepChange($event)"
                            placeholder="00000-000" maxlength="9" inputmode="numeric" autocomplete="postal-code"
                            [class.input-success]="cepEncontrado() === true"
                            [class.input-error]="cepEncontrado() === false">
                        @if (buscandoCep()) {
                        <span class="input-spinner"></span>
                        }
                        @if (cepEncontrado() === true) {
                        <span class="input-icon success">‚úì</span>
                        }
                        @if (cepEncontrado() === false) {
                        <span class="input-icon error">‚úó</span>
                        }
                    </div>
                    @if (cepEncontrado() === false) {
                    <span class="form-hint error">CEP n√£o encontrado. <a
                            href="https://buscacepinter.correios.com.br/app/endereco/index.php" target="_blank"
                            rel="noopener">N√£o sabe seu CEP?</a></span>
                    }
                    @if (cepEncontrado() === true) {
                    <span class="form-hint success">Endere√ßo preenchido automaticamente!</span>
                    }
                </div>

                <div class="form-group">
                    <label for="cad-logradouro">Rua / Avenida *</label>
                    <input type="text" id="cad-logradouro" name="logradouro" [ngModel]="formCadastro().logradouro"
                        (ngModelChange)="atualizarFormCadastro('logradouro', $event)" placeholder="Nome da rua"
                        maxlength="255" autocomplete="street-address">
                </div>

                <div class="form-row">
                    <div class="form-group form-group-small">
                        <label for="cad-numero">N√∫mero *</label>
                        <input type="text" id="cad-numero" name="numero" [ngModel]="formCadastro().numero"
                            (ngModelChange)="atualizarFormCadastro('numero', $event)" placeholder="N¬∫" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="cad-complemento">Complemento</label>
                        <input type="text" id="cad-complemento" name="complemento"
                            [ngModel]="formCadastro().complemento"
                            (ngModelChange)="atualizarFormCadastro('complemento', $event)" placeholder="Apto, bloco..."
                            maxlength="100">
                    </div>
                </div>

                <div class="form-group">
                    <label for="cad-bairro">Bairro *</label>
                    <input type="text" id="cad-bairro" name="bairro" [ngModel]="formCadastro().bairro"
                        (ngModelChange)="atualizarFormCadastro('bairro', $event)" placeholder="Seu bairro"
                        maxlength="100">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="cad-cidade">Cidade *</label>
                        <input type="text" id="cad-cidade" name="cidade" [ngModel]="formCadastro().cidade"
                            (ngModelChange)="atualizarFormCadastro('cidade', $event)" placeholder="Sua cidade"
                            maxlength="100">
                    </div>
                    <div class="form-group form-group-small">
                        <label for="cad-estado">UF *</label>
                        <input type="text" id="cad-estado" name="estado" [ngModel]="formCadastro().estado"
                            (ngModelChange)="atualizarFormCadastro('estado', $event.toUpperCase())" placeholder="SP"
                            maxlength="2" style="text-transform: uppercase;">
                    </div>
                </div>

                <div class="form-group">
                    <label for="cad-referencia">Ponto de refer√™ncia</label>
                    <input type="text" id="cad-referencia" name="pontoReferencia"
                        [ngModel]="formCadastro().pontoReferencia"
                        (ngModelChange)="atualizarFormCadastro('pontoReferencia', $event)"
                        placeholder="Pr√≥ximo ao mercado..." maxlength="255">
                </div>

                <div class="mapa-wrapper">
                    <label>Localiza√ß√£o Exata (Arraste o pino para corrigir)</label>
                    <div #mapContainer class="map-container"></div>
                    @if (errorMessageMap) {
                    <div class="error-msg">{{ errorMessageMap }}</div>
                    }
                </div>

                <button type="submit" class="btn-primary btn-large"
                    [disabled]="!enderecoCadastroValido() || cadastroCarregando()">
                    @if (cadastroCarregando()) {
                    <span class="spinner"></span> Criando conta...
                    } @else {
                    Criar conta e pedir
                    }
                </button>
            </form>
            }
        </div>
    </div>
    }

    <!-- ========== CARD√ÅPIO (com abas) ========== -->
    @if (etapaAtual() === 'cardapio' && cliente()) {
    <header class="header-delivery">
        <div class="header-content">
            <img src="/assets/experimenta_ai_banner_circular.webp" alt="Logo" class="logo-mini">
            <div class="header-info">
                <span class="cliente-nome">Ol√°, {{ cliente()!.nome.split(' ')[0] }}!</span>
                <span class="tipo-badge">üõµ Delivery</span>
            </div>
            <button class="btn-logout" (click)="logout()" title="Sair">
                <span class="logout-icon">üö™</span>
                <span class="logout-badge">Sair</span>
            </button>
        </div>
    </header>

    @if (carregando()) {
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Carregando card√°pio...</p>
    </div>
    } @else {
    <!-- ========== ABA: IN√çCIO ========== -->
    @if (abaAtual() === 'inicio') {
    <div class="aba-inicio">
        <!-- Bem-vindo -->
        <div class="inicio-welcome">
            <h2>Ol√°, {{ cliente()!.nome.split(' ')[0] }}! üëã</h2>
            <p>O que voc√™ deseja pedir hoje?</p>
        </div>

        <!-- Destaques / Mais Populares -->
        <div class="inicio-section">
            <h2 class="section-titulo">üî• Mais Populares</h2>
            @if (inicio.produtosMaisPedidos().length > 0) {
            <div class="carrossel-horizontal" appDraggableScroll>
                @for (produto of inicio.produtosMaisPedidos(); track produto.id) {
                <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                    <button class="btn-favorito" [class.ativo]="favoritos.isFavorito(produto.id)"
                        (click)="toggleFavorito(produto.id, $event)"
                        [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                        {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                    @if (produto.foto) {
                    <div class="produto-imagem-mini">
                        <img [src]="produto.foto" [alt]="produto.nome" loading="lazy">
                    </div>
                    } @else {
                    <div class="produto-imagem-mini produto-sem-foto">
                        <span>üçΩÔ∏è</span>
                    </div>
                    }
                    <div class="produto-info-mini">
                        <span class="produto-nome-mini">{{ produto.nome }}</span>
                        @if (produto.quantidadeVendida) {
                        <span class="produto-pedidos">{{ produto.quantidadeVendida }} pedidos</span>
                        }
                        <span class="produto-preco-mini">{{ produto.preco | currency:'BRL' }}</span>
                    </div>
                </div>
                }
            </div>
            } @else {
            <p class="carrossel-vazio">Carregando produtos...</p>
            }
        </div>

        <!-- Favoritos da Galera -->
        @if (inicio.produtosMaisFavoritados().length > 0) {
        <div class="inicio-section">
            <h2 class="section-titulo">‚ù§Ô∏è Favoritos da Galera</h2>
            <div class="carrossel-horizontal" appDraggableScroll>
                @for (produto of inicio.produtosMaisFavoritados(); track produto.id) {
                <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                    <button class="btn-favorito" [class.ativo]="favoritos.isFavorito(produto.id)"
                        (click)="toggleFavorito(produto.id, $event)"
                        [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                        {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                    @if (produto.foto) {
                    <div class="produto-imagem-mini">
                        <img [src]="produto.foto" [alt]="produto.nome" loading="lazy">
                    </div>
                    } @else {
                    <div class="produto-imagem-mini produto-sem-foto">
                        <span>üçΩÔ∏è</span>
                    </div>
                    }
                    <div class="produto-info-mini">
                        <span class="produto-nome-mini">{{ produto.nome }}</span>
                        @if (produto.quantidadeFavoritos) {
                        <span class="produto-pedidos">{{ produto.quantidadeFavoritos }} ‚ù§Ô∏è</span>
                        }
                        <span class="produto-preco-mini">{{ produto.preco | currency:'BRL' }}</span>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Bem Avaliados -->
        @if (inicio.produtosBemAvaliados().length > 0) {
        <div class="inicio-section">
            <h2 class="section-titulo">‚≠ê Bem Avaliados</h2>
            <div class="carrossel-horizontal" appDraggableScroll>
                @for (produto of inicio.produtosBemAvaliados(); track produto.id) {
                <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                    <button class="btn-favorito" [class.ativo]="favoritos.isFavorito(produto.id)"
                        (click)="toggleFavorito(produto.id, $event)"
                        [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                        {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                    @if (produto.foto) {
                    <div class="produto-imagem-mini">
                        <img [src]="produto.foto" [alt]="produto.nome" loading="lazy">
                    </div>
                    } @else {
                    <div class="produto-imagem-mini produto-sem-foto">
                        <span>üçΩÔ∏è</span>
                    </div>
                    }
                    <div class="produto-info-mini">
                        <span class="produto-nome-mini">{{ produto.nome }}</span>
                        @if (produto.mediaAvaliacao) {
                        <span class="produto-avaliacao">‚≠ê {{ produto.mediaAvaliacao.toFixed(1) }}</span>
                        }
                        <span class="produto-preco-mini">{{ produto.preco | currency:'BRL' }}</span>
                    </div>
                </div>
                }
            </div>
        </div>
        }

        <!-- Categorias R√°pidas -->
        <div class="inicio-section">
            <h2 class="section-titulo">üìã Categorias</h2>
            <div class="categorias-grid">
                @for (categoria of categorias(); track categoria.id) {
                <button class="categoria-card" (click)="selecionarCategoria(categoria.nome); navegarPara('cardapio')">
                    <span class="categoria-nome">{{ categoria.nome }}</span>
                </button>
                }
            </div>
        </div>

        <!-- Ver Card√°pio Completo -->
        <div class="inicio-cta">
            <button class="btn-primary btn-large" (click)="navegarPara('cardapio')">
                üìã Ver Card√°pio Completo
            </button>
        </div>
    </div>
    }

    <!-- ========== ABA: CARD√ÅPIO ========== -->
    @if (abaAtual() === 'cardapio') {
    <!-- Categorias -->
    <div class="categorias-scroll">
        <button class="categoria-chip" [class.ativa]="categoriaSelecionada() === null"
            (click)="selecionarCategoria(null)">
            üçΩÔ∏è Todos
        </button>
        @for (categoria of categorias(); track categoria.id) {
        <button class="categoria-chip" [class.ativa]="categoriaSelecionada() === categoria.nome"
            (click)="selecionarCategoria(categoria.nome)">
            {{ categoria.nome }}
        </button>
        }
    </div>

    <!-- Lista de Produtos -->
    <div class="produtos-container">
        <!-- Exibi√ß√£o agrupada por categoria (quando "Todos" selecionado) -->
        @if (categoriaSelecionada() === null) {
        @for (grupo of produtosAgrupadosPorCategoria(); track grupo.id) {
        <div class="categoria-section">
            <h2 class="categoria-titulo">{{ grupo.nome }}</h2>
            <div class="produtos-grid">
                @for (produto of grupo.produtos; track produto.id) {
                <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                    @if (produto.foto) {
                    <div class="produto-imagem">
                        <img [src]="produto.foto" [alt]="produto.nome" loading="lazy">
                    </div>
                    } @else {
                    <div class="produto-imagem produto-sem-foto">
                        <span>üçΩÔ∏è</span>
                    </div>
                    }
                    <div class="produto-info">
                        <h3 class="produto-nome">{{ produto.nome }}</h3>
                        @if (produto.descricao) {
                        <p class="produto-descricao">{{ produto.descricao }}</p>
                        }
                        <div class="produto-preco">{{ produto.preco | currency:'BRL' }}</div>
                    </div>
                    <div class="produto-acoes-lateral">
                        <button class="btn-favorito-mini" [class.ativo]="favoritos.isFavorito(produto.id)"
                            (click)="toggleFavorito(produto.id, $event)"
                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                        </button>
                        <button class="btn-adicionar-card"
                            (click)="adicionarAoCarrinhoRapido(produto); $event.stopPropagation()"
                            aria-label="Adicionar ao carrinho">
                            +
                        </button>
                    </div>
                </div>
                }
            </div>
        </div>
        } @empty {
        <div class="sem-produtos">
            <p>Nenhum produto dispon√≠vel</p>
        </div>
        }
        } @else {
        <!-- Exibi√ß√£o normal (categoria espec√≠fica selecionada) -->
        <div class="produtos-grid">
            @for (produto of produtosFiltrados(); track produto.id) {
            <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                @if (produto.foto) {
                <div class="produto-imagem">
                    <img [src]="produto.foto" [alt]="produto.nome" loading="lazy">
                </div>
                } @else {
                <div class="produto-imagem produto-sem-foto">
                    <span>üçΩÔ∏è</span>
                </div>
                }
                <div class="produto-info">
                    <h3 class="produto-nome">{{ produto.nome }}</h3>
                    @if (produto.descricao) {
                    <p class="produto-descricao">{{ produto.descricao }}</p>
                    }
                    <div class="produto-preco">{{ produto.preco | currency:'BRL' }}</div>
                </div>
                <div class="produto-acoes-lateral">
                    <button class="btn-favorito-mini" [class.ativo]="favoritos.isFavorito(produto.id)"
                        (click)="toggleFavorito(produto.id, $event)"
                        [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                        {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                    </button>
                    <button class="btn-adicionar-card"
                        (click)="adicionarAoCarrinhoRapido(produto); $event.stopPropagation()"
                        aria-label="Adicionar ao carrinho">
                        +
                    </button>
                </div>
            </div>
            } @empty {
            <div class="sem-produtos">
                <p>Nenhum produto dispon√≠vel nesta categoria</p>
            </div>
            }
        </div>
        }
    </div>
    }

    <!-- ========== ABA: CARRINHO ========== -->
    @if (abaAtual() === 'carrinho') {
    <div class="aba-carrinho">
        <div class="aba-header">
            <h2>üõí Seu Carrinho</h2>
        </div>

        @if (carrinhoVazio()) {
        <div class="carrinho-vazio">
            <span class="vazio-icon">üõí</span>
            <p>Seu carrinho est√° vazio</p>
            <button class="btn-secondary" (click)="navegarPara('cardapio')">Ver card√°pio</button>
        </div>
        } @else {
        <div class="carrinho-items">
            @for (item of itensCarrinho(); track item.produto.id; let i = $index) {
            <div class="carrinho-item">
                <div class="item-info">
                    <h4>{{ item.produto.nome }}</h4>
                    @if (formatarAdicionaisItem(item)) {
                    <p class="item-adicionais">+ {{ formatarAdicionaisItem(item) }}</p>
                    }
                    @if (item.observacao) {
                    <p class="item-obs">üìù {{ item.observacao }}</p>
                    }
                </div>
                <div class="item-controls">
                    <div class="quantidade-mini">
                        <button (click)="decrementarItemCarrinho(i)">‚àí</button>
                        <span>{{ item.quantidade }}</span>
                        <button (click)="incrementarItemCarrinho(i)">+</button>
                    </div>
                    <span class="item-preco">{{ calcularTotalItem(item) | currency:'BRL' }}</span>
                </div>
            </div>
            }
        </div>

        <div class="carrinho-footer">
            <div class="carrinho-total-row">
                <span>Total</span>
                <span class="total-valor">{{ totalCarrinho() | currency:'BRL' }}</span>
            </div>
            <button class="btn-primary btn-large" (click)="irParaCheckout()">
                Continuar ‚Üí
            </button>
        </div>
        }
    </div>
    }

    <!-- ========== ABA: PERFIL ========== -->
    @if (abaAtual() === 'perfil') {
    <div class="aba-perfil">
        <!-- Se√ß√£o Principal do Perfil -->
        @if (secaoPerfil() === 'principal') {
        <div class="perfil-header">
            <div class="perfil-avatar">
                @if (cliente()?.fotoUrl) {
                <img [src]="cliente()!.fotoUrl" alt="Foto" class="avatar-img">
                } @else {
                <span class="avatar-placeholder">üë§</span>
                }
            </div>
            <h2 class="perfil-nome">{{ cliente()!.nome }}</h2>
            @if (cliente()!.telefone) {
            <p class="perfil-telefone">{{ cliente()!.telefone }}</p>
            }
            @if (cliente()?.email) {
            <p class="perfil-email">{{ cliente()!.email }}</p>
            }
        </div>

        <div class="perfil-menu">
            <!-- Adicionar/Editar Celular -->
            <button class="perfil-item" (click)="secaoPerfil.set('edicao')">
                <span class="item-icon">üì±</span>
                <span class="item-texto">
                    @if (cliente()?.telefone) {
                    Meu celular
                    } @else {
                    Adicionar celular
                    }
                </span>
                @if (cliente()?.telefone) {
                <span class="item-badge telefone">{{ cliente()!.telefone }}</span>
                }
                <span class="item-arrow">‚Ä∫</span>
            </button>

            <!-- Meus Pedidos -->
            <button class="perfil-item" (click)="secaoPerfil.set('pedidos')">
                <span class="item-icon">üìã</span>
                <span class="item-texto">Meus Pedidos</span>
                <span class="item-arrow">‚Ä∫</span>
            </button>

            <!-- Favoritos -->
            <button class="perfil-item" (click)="secaoPerfil.set('favoritos')">
                <span class="item-icon">‚ù§Ô∏è</span>
                <span class="item-texto">Favoritos</span>
                @if (favoritos.quantidadeFavoritos() > 0) {
                <span class="item-count">{{ favoritos.quantidadeFavoritos() }}</span>
                }
                <span class="item-arrow">‚Ä∫</span>
            </button>

            <!-- Endere√ßo -->
            <button class="perfil-item" (click)="secaoPerfil.set('edicao')">
                <span class="item-icon">üìç</span>
                <span class="item-texto">Endere√ßo de entrega</span>
                <span class="item-arrow">‚Ä∫</span>
            </button>

            <!-- Editar Dados -->
            <button class="perfil-item" (click)="secaoPerfil.set('edicao')">
                <span class="item-icon">‚úèÔ∏è</span>
                <span class="item-texto">Editar meus dados</span>
                <span class="item-arrow">‚Ä∫</span>
            </button>

            <!-- Sair -->
            <button class="perfil-item sair" (click)="logout()">
                <span class="item-icon">üö™</span>
                <span class="item-texto">Sair da conta</span>
                <span class="item-arrow">‚Ä∫</span>
            </button>
        </div>

        <p class="perfil-info">üõµ Soneca Delivery</p>
        }

        <!-- Se√ß√£o Meus Pedidos -->
        @if (secaoPerfil() === 'pedidos') {
        <div class="secao-header">
            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                <span>‚Äπ</span>
            </button>
            <h2 class="secao-titulo">Meus Pedidos</h2>
        </div>
        <div class="lista-pedidos">
            @if (meusPedidos.carregando() && meusPedidos.pedidos().length === 0) {
            <div class="lista-carregando">
                <div class="loading-spinner"></div>
                <p>Carregando pedidos...</p>
            </div>
            } @else if (meusPedidos.pedidos().length === 0) {
            <div class="lista-vazia">
                <span class="lista-vazia-icon">üìã</span>
                <p>Nenhum pedido realizado ainda</p>
                <small>Seus pedidos aparecer√£o aqui</small>
            </div>
            } @else {
            @for (pedido of meusPedidos.pedidos(); track pedido.id) {
            <div class="item-pedido clicavel" (click)="meusPedidos.isPedidoEmAndamento(pedido) 
                    ? acompanharPedidoPorId(pedido.id, pedido.tipoPedido) 
                    : meusPedidos.selecionarPedido(pedido)">
                <div class="pedido-header">
                    <span class="pedido-data">{{ pedido.createdAt | date:'dd/MM/yyyy HH:mm' }}</span>
                    <div class="pedido-status-wrapper">
                        @if (meusPedidos.isPedidoEmAndamento(pedido)) {
                        <span class="badge-em-andamento">üîµ Ativo</span>
                        } @else if ((pedido.status === 'FINALIZADO' || pedido.status === 'ENTREGUE') &&
                        !avaliacao.isPedidoAvaliado(pedido.id)) {
                        <span class="badge-pendente-avaliacao">‚≠ê Avaliar</span>
                        }
                        <span class="pedido-status" [class]="meusPedidos.classeStatus(pedido.status)">
                            {{ meusPedidos.formatarStatus(pedido.status) }}
                        </span>
                    </div>
                </div>
                <div class="pedido-itens">
                    @for (item of pedido.itens; track item.produtoNome) {
                    <div class="pedido-item-container">
                        <span class="pedido-item">{{ item.quantidade }}x {{ item.produtoNome }}</span>
                    </div>
                    }
                </div>
                <div class="pedido-footer">
                    <span class="pedido-total">{{ pedido.total | currency:'BRL' }}</span>
                    <div class="pedido-footer-right">
                        @if (pedido.tipoPedido) {
                        <span class="pedido-tipo">{{ pedido.tipoPedido === 'DELIVERY' ? 'üõµ Delivery' : 'üè™ Retirada'
                            }}</span>
                        }
                        @if (meusPedidos.isPedidoEmAndamento(pedido)) {
                        <span class="pedido-acompanhar">üìç Acompanhar ‚Ä∫</span>
                        } @else {
                        <span class="pedido-ver-mais">Ver detalhes ‚Ä∫</span>
                        }
                    </div>
                </div>
            </div>
            }

            @if (meusPedidos.temMais()) {
            <button class="btn-carregar-mais" (click)="meusPedidos.carregarMais()"
                [disabled]="meusPedidos.carregando()">
                @if (meusPedidos.carregando()) {
                <span class="spinner-sm"></span>
                } @else {
                Ver mais pedidos
                }
            </button>
            }
            }
        </div>

        <!-- Modal Detalhes do Pedido -->
        @if (meusPedidos.mostrandoDetalhes() && meusPedidos.pedidoSelecionado()) {
        <div class="modal-overlay" (click)="meusPedidos.fecharDetalhes()">
            <div class="modal-detalhes-pedido" (click)="$event.stopPropagation()">
                <div class="modal-header">
                    <h3>Pedido</h3>
                    <button class="btn-fechar-modal" (click)="meusPedidos.fecharDetalhes()">‚úï</button>
                </div>

                <div class="modal-body">
                    <div class="detalhes-info">
                        <div class="info-row">
                            <span class="info-label">Data:</span>
                            <span class="info-value">{{ meusPedidos.pedidoSelecionado()?.createdAt | date:'dd/MM/yyyy
                                HH:mm' }}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value pedido-status"
                                [class]="meusPedidos.classeStatus(meusPedidos.pedidoSelecionado()?.status || '')">
                                {{ meusPedidos.formatarStatus(meusPedidos.pedidoSelecionado()?.status || '') }}
                            </span>
                        </div>
                        @if (meusPedidos.pedidoSelecionado()?.tipoPedido) {
                        <div class="info-row">
                            <span class="info-label">Tipo:</span>
                            <span class="info-value">{{ meusPedidos.pedidoSelecionado()?.tipoPedido === 'DELIVERY' ? 'üõµ
                                Delivery' : 'üè™ Retirada' }}</span>
                        </div>
                        }
                    </div>

                    <div class="detalhes-itens">
                        <h4>Itens do Pedido</h4>
                        @for (item of meusPedidos.pedidoSelecionado()?.itens; track item.produtoNome) {
                        <div class="detalhe-item">
                            <div class="detalhe-item-header">
                                <div class="item-info">
                                    <span class="item-qtd">{{ item.quantidade }}x</span>
                                    <span class="item-nome">{{ item.produtoNome }}</span>
                                </div>
                                <span class="item-preco">{{ (item.preco * item.quantidade) | currency:'BRL' }}</span>
                            </div>
                        </div>
                        }
                    </div>

                    <div class="detalhes-total">
                        <span>Total:</span>
                        <strong>{{ meusPedidos.pedidoSelecionado()?.total | currency:'BRL' }}</strong>
                    </div>

                    <!-- Se√ß√£o de Avalia√ß√£o -->
                    @if (meusPedidos.pedidoSelecionado()?.status === 'FINALIZADO') {
                    <div class="secao-avaliacao">
                        <!-- Se j√° avaliou e n√£o est√° editando: mostra resumo -->
                        @if (avaliacao.pedidoJaAvaliado() && !avaliacao.isEditando()) {
                        <div class="avaliacao-resumo">
                            <div class="avaliacao-resumo-header">
                                <div class="avaliacao-resumo-info">
                                    <span class="avaliacao-resumo-titulo">Sua avalia√ß√£o</span>
                                    <div class="avaliacao-resumo-estrelas">
                                        @for (estrela of [1, 2, 3, 4, 5]; track estrela) {
                                        <span class="estrela-resumo"
                                            [class.ativa]="avaliacao.getMediaAvaliacaoPedido() >= estrela">
                                            {{ avaliacao.getMediaAvaliacaoPedido() >= estrela ? '‚òÖ' : '‚òÜ' }}
                                        </span>
                                        }
                                    </div>
                                </div>
                                <button class="btn-editar-avaliacao" (click)="avaliacao.entrarModoEdicao()">
                                    ‚úèÔ∏è Editar
                                </button>
                            </div>

                            @if (avaliacao.getComentarioPedido()) {
                            <div class="avaliacao-comentario-salvo">
                                <span class="comentario-label">üí¨ Seu coment√°rio:</span>
                                <p class="comentario-texto">"{{ avaliacao.getComentarioPedido() }}"</p>
                            </div>
                            }
                        </div>
                        } @else {
                        <!-- Modo de edi√ß√£o ou primeira avalia√ß√£o -->
                        <div class="avaliacao-edicao">
                            <div class="avaliacao-edicao-header">
                                <h4>‚≠ê Avalie este pedido</h4>
                                @if (avaliacao.pedidoJaAvaliado()) {
                                <span class="avaliacao-modo-edicao">Editando</span>
                                }
                            </div>

                            <div class="itens-avaliacao-lista">
                                @for (item of meusPedidos.pedidoSelecionado()?.itens; track item.produtoNome) {
                                <div class="item-avaliacao">
                                    <span class="item-nome-avaliacao">{{ item.produtoNome }}</span>
                                    <div class="estrelas-avaliacao">
                                        @for (estrela of [1, 2, 3, 4, 5]; track estrela) {
                                        <button class="estrela-btn"
                                            [class.ativa]="avaliacao.getAvaliacaoProduto(item.produtoNome) >= estrela"
                                            (click)="avaliacao.avaliarProduto(item.produtoNome, estrela)">
                                            {{ avaliacao.getAvaliacaoProduto(item.produtoNome) >= estrela ? '‚òÖ' : '‚òÜ' }}
                                        </button>
                                        }
                                    </div>
                                </div>
                                }
                            </div>

                            <!-- Campo de coment√°rio -->
                            <div class="comentario-avaliacao">
                                <label for="comentario-pedido">üí¨ Deixe um coment√°rio (opcional)</label>
                                <textarea id="comentario-pedido" [value]="avaliacao.getComentarioPedido()"
                                    (input)="avaliacao.setComentarioPedido($any($event.target).value)"
                                    placeholder="O que voc√™ achou do pedido?" rows="3" maxlength="500"></textarea>
                            </div>

                            <button class="btn-enviar-avaliacao"
                                [disabled]="!avaliacao.temAlgumaAvaliacao() || avaliacao.salvando()"
                                (click)="avaliacao.enviarAvaliacao()">
                                @if (avaliacao.salvando()) {
                                <span class="spinner-sm"></span> Enviando...
                                } @else {
                                Enviar avalia√ß√£o
                                }
                            </button>
                        </div>
                        }
                    </div>
                    }
                </div>
            </div>
        </div>
        }
        }
        <!-- Se√ß√£o Favoritos -->
        @if (secaoPerfil() === 'favoritos') {
        <div class="secao-header">
            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                <span>‚Äπ</span>
            </button>
            <h2 class="secao-titulo">Favoritos</h2>
        </div>
        <div class="lista-favoritos">
            @if (favoritos.carregando()) {
            <div class="lista-carregando">
                <div class="loading-spinner"></div>
                <p>Carregando favoritos...</p>
            </div>
            } @else if (favoritos.produtosFavoritos().length === 0) {
            <div class="lista-vazia">
                <span class="lista-vazia-icon">‚ù§Ô∏è</span>
                <p>Nenhum favorito ainda</p>
                <small>Toque no ‚ù§Ô∏è nos produtos para adicionar</small>
            </div>
            } @else {
            @for (produto of favoritos.produtosFavoritos(); track produto.id) {
            <div class="item-favorito" (click)="abrirDetalhesProduto(produto)">
                @if (produto.foto) {
                <div class="favorito-imagem">
                    <img [src]="produto.foto" [alt]="produto.nome">
                </div>
                } @else {
                <div class="favorito-imagem sem-foto">
                    <span>üçΩÔ∏è</span>
                </div>
                }
                <div class="favorito-info">
                    <span class="favorito-nome">{{ produto.nome }}</span>
                    <span class="favorito-preco">{{ produto.preco | currency:'BRL' }}</span>
                </div>
                <button class="btn-remover-favorito" (click)="favoritos.remover(produto.id); $event.stopPropagation()">
                    üóëÔ∏è
                </button>
            </div>
            }
            }
        </div>
        }

        <!-- Se√ß√£o Edi√ß√£o -->
        @if (secaoPerfil() === 'edicao') {
        <div class="secao-header">
            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                <span>‚Äπ</span>
            </button>
            <h2 class="secao-titulo">Editar Dados</h2>
        </div>
        <app-menu-perfil [cliente]="cliente()!" [visivel]="true" (fechar)="secaoPerfil.set('principal')"
            (clienteAtualizado)="onClienteAtualizado($event)" />
        }
    </div>
    }

    <!-- ========== CTAs GLOBAIS DE NOTIFICA√á√ÉO ========== -->
    @if (etapaAtual() !== 'sucesso' && etapaAtual() !== 'checkout' && !ctaAvaliacaoFechado()) {
    <div class="ctas-container">
        <!-- CTA Acompanhar Pedido em andamento (sucesso recente) -->
        @if (sucessoPedido.pedidoId() && !sucessoPedido.pedidoTerminado()) {
        <div class="cta-acompanhar-float" (click)="irParaAcompanhamento()">
            <button class="cta-close" (click)="fecharCtaAcompanhamento(); $event.stopPropagation()">‚úï</button>
            <span class="cta-icon">üõµ</span>
            <span class="cta-texto">Seu pedido est√° <strong>{{ sucessoPedido.statusDescricao() }}</strong></span>
            <span class="cta-seta">‚Ä∫</span>
        </div>
        }

        <!-- CTA Acompanhar Pedidos em andamento (do hist√≥rico) -->
        @if (!sucessoPedido.pedidoId() && meusPedidos.temPedidosEmAndamento() && !ctaAcompanhamentoFechado()) {
        <div class="cta-acompanhar-float" (click)="acompanharPedidoEmAndamento()">
            <button class="cta-close" (click)="fecharCtaAcompanhamento(); $event.stopPropagation()">‚úï</button>
            <span class="cta-icon">üõµ</span>
            <span class="cta-texto">Voc√™ tem <strong>{{ meusPedidos.pedidosEmAndamento().length }} pedido(s)</strong> em
                andamento</span>
            <span class="cta-seta">‚Ä∫</span>
        </div>
        }

        <!-- CTA Avalia√ß√£o -->
        @if (pedidosNaoAvaliadosCorrigido().length > 0 && !sucessoPedido.pedidoId()) {
        <div class="cta-avaliacao-float" (click)="abrirAvaliacaoPedido()">
            <button class="cta-close" (click)="fecharCtaAvaliacao(); $event.stopPropagation()">‚úï</button>
            <span class="cta-icon">‚≠ê</span>
            <span class="cta-texto">Voc√™ tem <strong>{{ pedidosNaoAvaliadosCorrigido().length }} pedido(s)</strong>
                para avaliar!</span>
            <span class="cta-seta">‚Ä∫</span>
        </div>
        }

        <!-- CTA Telefone -->
        @if (deveMostrarCtaTelefoneGlobal()) {
        <div class="cta-telefone-float" (click)="abrirPerfilParaCadastrarTelefone()">
            <button class="cta-close" (click)="fecharCtaTelefone(); $event.stopPropagation()">‚úï</button>
            <span class="cta-icon">üì±</span>
            <span class="cta-texto">Cadastre seu celular para <strong>facilitar o atendimento</strong></span>
            <span class="cta-seta">‚Ä∫</span>
        </div>
        }
    </div>
    }

    <!-- ========== FOOTER NAVEGA√á√ÉO ========== -->
    <app-footer-nav [abaAtual]="abaAtual()" [totalCarrinho]="quantidadeItensCarrinho()" (abaMudou)="navegarPara($event)"
        (abrirCarrinho)="navegarPara('carrinho')" />
    }
    }

    <!-- ========== MODAL DETALHES PRODUTO ========== -->
    @if (mostrarDetalhes() && produtoSelecionado()) {
    <div class="modal-overlay" (click)="fecharDetalhes()">
        <div class="modal-content modal-produto" (click)="$event.stopPropagation()">
            <button class="modal-close" (click)="fecharDetalhes()">‚úï</button>

            @if (produtoSelecionado()!.foto) {
            <div class="modal-produto-imagem">
                <img [src]="produtoSelecionado()!.foto" [alt]="produtoSelecionado()!.nome">
            </div>
            }

            <div class="modal-produto-info">
                <h2>{{ produtoSelecionado()!.nome }}</h2>
                @if (produtoSelecionado()!.descricao) {
                <p class="descricao">{{ produtoSelecionado()!.descricao }}</p>
                }
                <span class="preco">{{ produtoSelecionado()!.preco | currency:'BRL' }}</span>
            </div>

            <!-- Adicionais -->
            @if (carregandoAdicionais()) {
            <div class="adicionais-loading">
                <span class="spinner-adicionais"></span>
                <span>Carregando adicionais...</span>
            </div>
            } @else if (adicionaisDisponiveis().length > 0) {
            <div class="adicionais-secao">
                <button class="btn-expandir-adicionais" [class.expandido]="adicionaisExpandido()"
                    (click)="toggleAdicionaisExpandido()">
                    <span class="adicionais-titulo">üçï Adicionais ({{ adicionaisDisponiveis().length }})</span>
                    @if (adicionaisSelecionados().length > 0) {
                    <span class="adicionais-badge">{{ adicionaisSelecionados().length }} selecionado(s)</span>
                    }
                    <span class="expandir-icone">{{ adicionaisExpandido() ? '‚ñ≤' : '‚ñº' }}</span>
                </button>

                @if (adicionaisExpandido()) {
                <div class="adicionais-lista">
                    @for (adicional of adicionaisDisponiveis(); track adicional.id) {
                    <div class="adicional-item" [class.selecionado]="isAdicionalSelecionado(adicional.id)"
                        (click)="toggleAdicional(adicional)">
                        <div class="adicional-info">
                            <span class="adicional-nome">{{ adicional.nome }}</span>
                            <span class="adicional-preco">+ {{ adicional.preco | currency:'BRL' }}</span>
                        </div>
                        @if (isAdicionalSelecionado(adicional.id)) {
                        <div class="adicional-quantidade" (click)="$event.stopPropagation()">
                            <button class="btn-adicional-qtd" (click)="decrementarAdicional(adicional.id)">‚àí</button>
                            <span class="adicional-qtd-valor">{{ getQuantidadeAdicional(adicional.id) }}</span>
                            <button class="btn-adicional-qtd" (click)="incrementarAdicional(adicional.id)">+</button>
                        </div>
                        }
                    </div>
                    }
                </div>
                }
                @if (subtotalAdicionais() > 0) {
                <div class="adicionais-subtotal">
                    Adicionais: {{ subtotalAdicionais() | currency:'BRL' }}
                </div>
                }
            </div>
            }

            <!-- Observa√ß√£o -->
            <div class="observacao-section">
                <label for="observacao">Alguma observa√ß√£o?</label>
                <textarea id="observacao" [ngModel]="observacaoItem()" (ngModelChange)="observacaoItem.set($event)"
                    placeholder="Ex: sem cebola, bem passado..." rows="2" maxlength="500"></textarea>
            </div>

            <!-- Quantidade e Adicionar -->
            <div class="modal-footer">
                <div class="quantidade-control">
                    <button (click)="decrementarQuantidade()" [disabled]="quantidadeSelecionada() <= 1">‚àí</button>
                    <span>{{ quantidadeSelecionada() }}</span>
                    <button (click)="incrementarQuantidade()">+</button>
                </div>
                <button class="btn-adicionar" (click)="adicionarAoCarrinho()">
                    Adicionar {{ ((produtoSelecionado()!.preco + subtotalAdicionais()) * quantidadeSelecionada()) |
                    currency:'BRL' }}
                </button>
            </div>
        </div>
    </div>
    }

    <!-- ========== CHECKOUT ========== -->
    @if (etapaAtual() === 'checkout') {
    <div class="checkout-screen">
        <header class="checkout-header">
            <button class="btn-back" (click)="voltarParaCardapio()">‚Üê Voltar</button>
            <h1>Finalizar Pedido</h1>
        </header>

        <div class="checkout-content">
            <!-- Tipo de Pedido -->
            <section class="checkout-section">
                <h3>Como deseja receber?</h3>
                <div class="tipo-pedido-options">
                    <button class="tipo-option" [class.selected]="tipoPedido() === 'DELIVERY'"
                        (click)="tipoPedido.set('DELIVERY')">
                        üõµ Delivery
                    </button>
                    <button class="tipo-option" [class.selected]="tipoPedido() === 'RETIRADA'"
                        (click)="tipoPedido.set('RETIRADA')">
                        üèÉ Retirar no local
                    </button>
                </div>
            </section>

            <!-- Endere√ßo -->
            @if (tipoPedido() === 'DELIVERY') {
            <section class="checkout-section">
                <h3>üìç Endere√ßo de entrega</h3>
                <div class="endereco-display">
                    @if (cliente()?.enderecoFormatado) {
                    <p>{{ cliente()!.enderecoFormatado }}</p>
                    <button class="btn-link" (click)="enderecoEntrega.set('')">Alterar</button>
                    } @else {
                    <textarea [ngModel]="enderecoEntrega()" (ngModelChange)="enderecoEntrega.set($event)"
                        placeholder="Digite seu endere√ßo completo" rows="2"></textarea>
                    }
                </div>
            </section>
            }

            <!-- Resumo do Pedido -->
            <section class="checkout-section">
                <h3>üìã Resumo do pedido</h3>
                <div class="resumo-items">
                    @for (item of itensCarrinho(); track $index) {
                    <div class="resumo-item">
                        <span>{{ item.quantidade }}x {{ item.produto.nome }}</span>
                        <span>{{ (item.produto.preco * item.quantidade) | currency:'BRL' }}</span>
                    </div>
                    }
                </div>
                <div class="resumo-total">
                    <span>Total</span>
                    <span>{{ totalCarrinho() | currency:'BRL' }}</span>
                </div>
            </section>

            <!-- Forma de Pagamento -->
            <section class="checkout-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">üí≥ Forma de pagamento</h3>
                    <label class="toggle-container"
                        style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" [checked]="pagamentoDividido()" (change)="toggleDividido()"
                            style="width: auto;">
                        <span style="font-size: 0.9rem; color: var(--text-secondary);">Dividir pagamento</span>
                    </label>
                </div>

                <div class="pagamento-options">
                    <!-- PIX -->
                    <div class="meio-pagamento-item">
                        <button class="pagamento-option" [class.selected]="isMeioSelecionado('PIX')"
                            (click)="selecionarMeioPagamento('PIX')">
                            <span>üì±</span> PIX
                        </button>
                        @if (pagamentoDividido() && isMeioSelecionado('PIX')) {
                        <div class="valor-input-container">
                            <label>Valor</label>
                            <input type="number" [ngModel]="getValorMeio('PIX')"
                                (ngModelChange)="atualizarValorMeio('PIX', $event)" placeholder="0.00" step="0.01">
                        </div>
                        }
                    </div>

                    <!-- CR√âDITO -->
                    <div class="meio-pagamento-item">
                        <button class="pagamento-option" [class.selected]="isMeioSelecionado('CARTAO_CREDITO')"
                            (click)="selecionarMeioPagamento('CARTAO_CREDITO')">
                            <span>üí≥</span> Cr√©dito
                        </button>
                        @if (pagamentoDividido() && isMeioSelecionado('CARTAO_CREDITO')) {
                        <div class="valor-input-container">
                            <label>Valor</label>
                            <input type="number" [ngModel]="getValorMeio('CARTAO_CREDITO')"
                                (ngModelChange)="atualizarValorMeio('CARTAO_CREDITO', $event)" placeholder="0.00"
                                step="0.01">
                        </div>
                        }
                    </div>

                    <!-- D√âBITO -->
                    <div class="meio-pagamento-item">
                        <button class="pagamento-option" [class.selected]="isMeioSelecionado('CARTAO_DEBITO')"
                            (click)="selecionarMeioPagamento('CARTAO_DEBITO')">
                            <span>üí≥</span> D√©bito
                        </button>
                        @if (pagamentoDividido() && isMeioSelecionado('CARTAO_DEBITO')) {
                        <div class="valor-input-container">
                            <label>Valor</label>
                            <input type="number" [ngModel]="getValorMeio('CARTAO_DEBITO')"
                                (ngModelChange)="atualizarValorMeio('CARTAO_DEBITO', $event)" placeholder="0.00"
                                step="0.01">
                        </div>
                        }
                    </div>

                    <!-- VOUCHER -->
                    <div class="meio-pagamento-item">
                        <button class="pagamento-option" [class.selected]="isMeioSelecionado('VALE_REFEICAO')"
                            (click)="selecionarMeioPagamento('VALE_REFEICAO')">
                            <span>üé´</span> Voucher
                        </button>
                        @if (pagamentoDividido() && isMeioSelecionado('VALE_REFEICAO')) {
                        <div class="valor-input-container">
                            <label>Valor</label>
                            <input type="number" [ngModel]="getValorMeio('VALE_REFEICAO')"
                                (ngModelChange)="atualizarValorMeio('VALE_REFEICAO', $event)" placeholder="0.00"
                                step="0.01">
                        </div>
                        }
                    </div>

                    <!-- DINHEIRO -->
                    <div class="meio-pagamento-item">
                        <button class="pagamento-option" [class.selected]="isMeioSelecionado('DINHEIRO')"
                            (click)="selecionarMeioPagamento('DINHEIRO')">
                            <span>üíµ</span> Dinheiro
                        </button>
                        @if (pagamentoDividido() && isMeioSelecionado('DINHEIRO')) {
                        <div class="valor-input-container">
                            <label>Valor</label>
                            <input type="number" [ngModel]="getValorMeio('DINHEIRO')"
                                (ngModelChange)="atualizarValorMeio('DINHEIRO', $event)" placeholder="0.00" step="0.01">
                        </div>
                        }
                    </div>
                </div>

                @if (pagamentoDividido()) {
                <div class="resumo-pagamento"
                    style="margin-top: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: 8px;">
                    <div class="resumo-linha"
                        style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span>Total alocado:</span>
                        <span [style.color]="pagamentoValido() ? 'var(--success)' : 'var(--text-primary)'">
                            {{ totalAlocado() | currency:'BRL' }}
                        </span>
                    </div>

                    @if (valorRestante() > 0.01) {
                    <div class="resumo-linha"
                        style="display: flex; justify-content: space-between; color: var(--error);">
                        <span>Falta alocar:</span>
                        <span>{{ valorRestante() | currency:'BRL' }}</span>
                    </div>
                    }

                    @if (valorRestante() < -0.01) { <div class="resumo-linha"
                        style="display: flex; justify-content: space-between; color: var(--error);">
                        <span>Valor excedente:</span>
                        <span>{{ (valorRestante() * -1) | currency:'BRL' }}</span>
                </div>
                }
        </div>
        }
        </section>
    </div>

    <div class="checkout-footer">
        <button class="btn-primary btn-large" [disabled]="!podeEnviarPedido() || enviando()" (click)="enviarPedido()">
            @if (enviando()) {
            <span class="spinner"></span> Enviando...
            } @else {
            Confirmar Pedido
            }
        </button>
    </div>
</div>
}

<!-- ========== SUCESSO / ACOMPANHAMENTO ========== -->
@if (etapaAtual() === 'sucesso') {
<div class="sucesso-screen">
    <!-- Header com bot√£o voltar -->
    <div class="sucesso-header">
        <button class="btn-minimizar-status" (click)="novoPedido()">
            <span class="btn-minimizar-icon">‚Äπ</span>
            <span>Fazer novo pedido</span>
        </button>
    </div>

    <div class="sucesso-content">
        @if (sucessoPedido.pedidoCancelado()) {
        <!-- Pedido cancelado/rejeitado -->
        <div class="sucesso-card cancelado">
            <div class="sucesso-icon cancelado">‚ùå</div>
            <h2>Pedido Cancelado</h2>
            <p class="sucesso-main">Infelizmente seu pedido foi cancelado.</p>
            @if (sucessoPedido.statusPedido()?.motivoCancelamento) {
            <p class="motivo-cancelamento">
                Motivo: {{ sucessoPedido.statusPedido()?.motivoCancelamento }}
            </p>
            }
        </div>
        } @else {
        <!-- Pedido em andamento -->
        <div class="sucesso-card">
            <div class="sucesso-icon-wrapper">
                <div class="sucesso-icon" [class.pulsing]="!sucessoPedido.pedidoFinalizado()">
                    @if (sucessoPedido.pedidoFinalizado()) {
                    üéâ
                    } @else if (sucessoPedido.passoAtual() >= 3) {
                    üõµ
                    } @else if (sucessoPedido.passoAtual() === 2) {
                    üë®‚Äçüç≥
                    } @else {
                    ‚è≥
                    }
                </div>
            </div>

            @if (sucessoPedido.numeroPedido()) {
            <div class="numero-pedido-badge">
                Pedido #{{ sucessoPedido.numeroPedido() }}
            </div>
            }

            <h2 class="sucesso-titulo">{{ sucessoPedido.statusDescricao() }}</h2>

            <div class="sucesso-tipo-info">
                @if (tipoPedido() === 'DELIVERY') {
                <span class="tipo-icon">üõµ</span>
                <span>Delivery</span>
                } @else {
                <span class="tipo-icon">üè™</span>
                <span>Retirada no local</span>
                }
            </div>
        </div>

        <!-- Timeline de status -->
        <div class="sucesso-timeline">
            <!-- Passo 1: Pedido enviado (sempre completo) -->
            <div class="timeline-step completed">
                <div class="timeline-marker">
                    <span class="timeline-icon">‚úì</span>
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Pedido enviado</span>
                </div>
            </div>

            <!-- Passo 2: Aguardando confirma√ß√£o -->
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() > 1"
                [class.active]="sucessoPedido.passoAtual() === 1">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() > 1) {
                    <span class="timeline-icon">‚úì</span>
                    } @else {
                    <span class="timeline-icon waiting">‚è≥</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Confirma√ß√£o</span>
                    @if (sucessoPedido.passoAtual() === 1) {
                    <span class="timeline-sublabel">Aguardando confirma√ß√£o do estabelecimento</span>
                    }
                </div>
            </div>

            <!-- Passo 3: Em prepara√ß√£o -->
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() > 2"
                [class.active]="sucessoPedido.passoAtual() === 2" [class.pending]="sucessoPedido.passoAtual() < 2">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() > 2) {
                    <span class="timeline-icon">‚úì</span>
                    } @else if (sucessoPedido.passoAtual() === 2) {
                    <span class="timeline-icon cooking">üë®‚Äçüç≥</span>
                    } @else {
                    <span class="timeline-icon pending">‚óã</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Prepara√ß√£o</span>
                    @if (sucessoPedido.passoAtual() === 2) {
                    <span class="timeline-sublabel">Seu pedido est√° sendo preparado</span>
                    }
                </div>
            </div>

            <!-- Passo 4: Pronto (apenas para delivery) -->
            @if (tipoPedido() === 'DELIVERY') {
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() > 3"
                [class.active]="sucessoPedido.passoAtual() === 3" [class.pending]="sucessoPedido.passoAtual() < 3">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() > 3) {
                    <span class="timeline-icon">‚úì</span>
                    } @else if (sucessoPedido.passoAtual() === 3) {
                    <span class="timeline-icon done">‚úÖ</span>
                    } @else {
                    <span class="timeline-icon pending">‚óã</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Pronto!</span>
                    @if (sucessoPedido.passoAtual() === 3) {
                    <span class="timeline-sublabel">Iremos enviar em breve</span>
                    }
                </div>
            </div>

            <!-- Passo 5: Saiu para entrega (apenas para delivery) -->
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() > 4"
                [class.active]="sucessoPedido.passoAtual() === 4" [class.pending]="sucessoPedido.passoAtual() < 4">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() > 4) {
                    <span class="timeline-icon">‚úì</span>
                    } @else if (sucessoPedido.passoAtual() === 4) {
                    <span class="timeline-icon delivery">üõµ</span>
                    } @else {
                    <span class="timeline-icon pending">‚óã</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Saiu para entrega</span>
                    @if (sucessoPedido.passoAtual() === 4) {
                    <span class="timeline-sublabel">Seu pedido est√° a caminho!</span>
                    @if (sucessoPedido.tipoPedido() === 'DELIVERY') {
                        <button 
                            class="btn-rastrear"
                            (click)="abrirRastreamento()"
                            [disabled]="rastreamento.carregando()">
                            @if (rastreamento.carregando()) {
                                <span class="spinner-small"></span> Carregando...
                            } @else {
                                üìç Rastrear pedido
                            }
                        </button>
                        @if (rastreamento.temLocalizacaoMotoboy()) {
                            <div class="info-rastreamento">
                                <small>√öltima atualiza√ß√£o: {{ rastreamento.calcularTempoDesde(rastreamento.localizacaoMotoboy()?.timestamp) }}</small>
                            </div>
                        }
                    }
                    }
                </div>
            </div>

            <!-- Passo 6: Entregue (apenas para delivery) -->
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() >= 5"
                [class.pending]="sucessoPedido.passoAtual() < 5">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() >= 5) {
                    <span class="timeline-icon done">üéâ</span>
                    } @else {
                    <span class="timeline-icon pending">‚óã</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Entregue!</span>
                    @if (sucessoPedido.passoAtual() >= 5) {
                    <span class="timeline-sublabel">Aproveite sua refei√ß√£o!</span>
                    }
                </div>
            </div>
            } @else {
            <!-- Retirada: Pronto para retirada -->
            <div class="timeline-step" [class.completed]="sucessoPedido.passoAtual() >= 3"
                [class.pending]="sucessoPedido.passoAtual() < 3">
                <div class="timeline-marker">
                    @if (sucessoPedido.passoAtual() >= 3) {
                    <span class="timeline-icon done">üéâ</span>
                    } @else {
                    <span class="timeline-icon pending">‚óã</span>
                    }
                </div>
                <div class="timeline-content">
                    <span class="timeline-label">Pronto para retirada!</span>
                    @if (sucessoPedido.passoAtual() >= 3) {
                    <span class="timeline-sublabel">Venha buscar seu pedido</span>
                    }
                </div>
            </div>
            }
        </div>

        <!-- Info adicional: tempo de espera -->
        @if (!sucessoPedido.pedidoFinalizado()) {
        <div class="sucesso-tempo">
            <span class="tempo-icon">‚è±Ô∏è</span>
            <span>{{ sucessoPedido.formatarTempoEspera() }}</span>
        </div>
        }
        }

        <!-- A√ß√µes (dentro de sucesso-content para centraliza√ß√£o correta) -->
        <div class="sucesso-actions">
            @if (sucessoPedido.pedidoTerminado()) {
            <button class="btn-primary btn-large" (click)="novoPedido()">
                üõí Fazer Novo Pedido
            </button>
            } @else {
            <div class="sucesso-navegacao">
                <p class="aguardando-finalizacao">
                    Voc√™ pode continuar navegando enquanto aguarda
                </p>
                <button class="btn-secondary" (click)="voltarParaInicio()">
                    ‚Üê Voltar ao In√≠cio
                </button>
            </div>
            }
        </div>
    </div>
</div>
}
<!-- ========== CHAT IA ========== -->
@if (etapaAtual() !== 'boas-vindas' && etapaAtual() !== 'login' && etapaAtual() !== 'cadastro' && etapaAtual() !==
'sucesso') {
@if (!mostrarDetalhes()) {
<app-chat-ia-button-delivery [pulse]="(chatIA.mensagens().length <= 1) || !chatIA.isOpen()"
    (onClick)="chatIA.toggleChat()">
</app-chat-ia-button-delivery>
}

<app-chat-ia-fullscreen-delivery [isOpen]="chatIA.isOpen()" [isLoading]="chatIA.isLoading()"
    [inputText]="chatIA.inputText()" [canSend]="chatIA.canSend()" [mensagens]="chatIA.mensagens()"
    [quantidadeItensCarrinho]="itensCarrinho().length" [historicoConversas]="chatIA.historicoConversas()"
    [mostrarHistorico]="chatIA.mostrarHistorico()" [isHidden]="mostrarDetalhes() || mostrarCarrinho()"
    (onClose)="chatIA.fecharChat()" (onSend)="chatIA.enviarMensagem()" (onInputChange)="chatIA.setInputText($event)"
    (onNovaConversa)="chatIA.novaConversa()"
    (onAdicionarProduto)="executarAcaoChat({tipo: 'ADICIONAR_CARRINHO', produtoId: $event.id, produtoNome: $event.nome, quantidade: 1, observacao: null})"
    (onAbrirCarrinho)="navegarPara('carrinho'); chatIA.fecharChat()" (onToggleHistorico)="chatIA.toggleHistorico()"
    (onCarregarConversa)="chatIA.carregarConversaDoHistorico($event)"
    (onRemoverConversa)="chatIA.removerDoHistorico($event)">
</app-chat-ia-fullscreen-delivery>
}

} <!-- Fim do @else statusLoja === ABERTA -->
</div>

<!-- Modal de Rastreamento -->
<app-modal-rastreamento
    [aberto]="modalRastreamentoAberto()"
    [rastreamento]="rastreamento.rastreamento()"
    (onFechar)="fecharModalRastreamento()">
</app-modal-rastreamento>