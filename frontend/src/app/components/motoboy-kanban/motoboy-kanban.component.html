<div class="kanban-container">
  <header class="kanban-header">
    <div class="header-content">
      <h1 class="kanban-titulo">
        <img src="/assets/experimenta_ai_banner_circular.png" alt="Experimenta a√≠" class="kanban-logo" />
        Minhas Entregas
      </h1>

      <div class="header-info">
        @if (motoboy()) {
        <div class="motoboy-info-header">
          @if (motoboy()!.fotoUrl) {
          <img [src]="motoboy()!.fotoUrl" [alt]="motoboy()!.nome" class="motoboy-foto-header" />
          } @else {
          <div class="motoboy-avatar-header">üõµ</div>
          }
          <div class="motoboy-detalhes-header">
            <span class="motoboy-nome-header">{{ motoboy()!.apelido || motoboy()!.nome }}</span>
            @if (motoboy()!.apelido && motoboy()!.apelido !== motoboy()!.nome) {
            <span class="motoboy-nome-completo">{{ motoboy()!.nome }}</span>
            }
          </div>
        </div>
        }

        <div class="total-entregas">
          <span class="total-label">Total de Entregas:</span>
          <span class="total-value">{{ totalEntregas() }}</span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-sair" (click)="logout()" aria-label="Sair">
          Sair
        </button>
      </div>
    </div>
  </header>

  <!-- PWA Install Banner (mesmo CTA da tela /delivery) -->
  @if (mostrarBannerPwa()) {
  <div class="pwa-install-banner">
    <div class="pwa-install-texto">
      <strong>Instale o app</strong>
      @if (pwaPromptDisponivel()) {
      <span>Atalho na tela inicial, experi√™ncia fullscreen e mais r√°pida.</span>
      } @else if (pwaInstrucao()) {
      <span>{{ pwaInstrucao() }}</span>
      } @else {
      <span>Atalho na tela inicial, experi√™ncia fullscreen e mais r√°pida.</span>
      }
    </div>
    <div class="pwa-install-botoes">
      <button class="pwa-btn-secundario" (click)="fecharBannerPwa()">Fechar</button>
      @if (pwaPromptDisponivel()) {
      <button class="pwa-btn-primario" (click)="instalarPwa()">Instalar</button>
      }
    </div>
  </div>
  }

  @if (reconectando()) {
  <div class="reconectando-mensagem">
    <div class="spinner pequeno"></div>
    <p>Reconectando...</p>
  </div>
  }

  @if (erro() && !reconectando()) {
  <div class="erro-mensagem">
    <p>{{ erro() }}</p>
    <button class="btn-recarregar" (click)="carregarPedidos()">
      Tentar novamente
    </button>
  </div>
  }

  @if (estaCarregando() && pedidos().length === 0) {
  <div class="estado-carregando">
    <div class="spinner"></div>
    <p>Carregando entregas...</p>
  </div>
  }

  @if (!estaCarregando()) {
  <div class="kanban-board">
    <!-- Quadro: Em Andamento -->
    <div class="kanban-quadro">
      <div class="quadro-header">
        <h3 class="quadro-titulo">üöÄ Em Andamento</h3>
      </div>
      <div class="quadro-conteudo">
        @if (pedidosEmAndamento().length === 0) {
        <div class="sem-pedidos-mensagem">
          <p>Voc√™ n√£o tem pedidos em andamento</p>
        </div>
        } @else {
        <div class="kanban-colunas">
          <!-- Coluna: SAIU_PARA_ENTREGA (Em Tr√¢nsito) -->
          <div class="kanban-coluna">
            <div class="status-section">
              <div class="status-header">
                <h4 class="status-titulo">üöö Em Tr√¢nsito</h4>
                <span class="status-count">{{ pedidosPorStatus().saiuParaEntrega.length }}</span>
              </div>
              <div class="pedidos-lista">
                @for (pedido of pedidosPorStatus().saiuParaEntrega; track pedido.id) {
                <div class="pedido-card em-entrega" [class.card-clicavel]="pedido.latitude && pedido.longitude"
                  [attr.role]="pedido.latitude && pedido.longitude ? 'button' : null"
                  [attr.tabindex]="pedido.latitude && pedido.longitude ? 0 : null"
                  (click)="abrirRotaParaEntrega(pedido)" (keydown)="abrirRotaComTeclado($event, pedido)"
                  [title]="pedido.latitude && pedido.longitude ? 'Clique ou pressione Enter para abrir rota no Google Maps' : 'Endere√ßo sem coordenadas - n√£o √© poss√≠vel abrir rota'">
                  <div class="pedido-header">
                    <div class="pedido-numero-wrapper">
                      <span class="pedido-numero">#{{ pedido.numeroPedido }}</span>
                    </div>
                    <div class="pedido-cliente-wrapper">
                      <span class="pedido-cliente">{{ pedido.clienteNome }}</span>
                    </div>
                  </div>
                  @if (pedido.enderecoEntrega) {
                  <div class="pedido-endereco">
                    üìç {{ pedido.enderecoEntrega }}
                  </div>
                  }
                  <div class="pedido-valor-pedido">
                    Pedido: {{ formatarValor(pedido.valorTotal) }}
                  </div>
                  @if (pedido.valorMotoboy) {
                  <div class="pedido-valor-entrega">
                    <span class="valor-motoboy-label">Valor entrega:</span>
                    <span class="valor-motoboy-valor">{{ formatarValor(pedido.valorMotoboy) }}</span>
                  </div>
                  }
                  <div class="pedido-tempo">
                    <span class="tempo-label">Em tr√¢nsito</span>
                  </div>
                  <div class="pedido-acoes">
                    <button class="btn-acao btn-entregue" (click)="$event.stopPropagation(); marcarComoEntregue(pedido)"
                      title="Marcar pedido como entregue">
                      ‚úì Marcar como Entregue
                    </button>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>

          <!-- Coluna: PRONTO -->
          <div class="kanban-coluna">
            <div class="status-section">
              <div class="status-header">
                <h4 class="status-titulo">‚úÖ Pronto</h4>
                <span class="status-count">{{ pedidosPorStatus().pronto.length }}</span>
              </div>
              <div class="pedidos-lista">
                @for (pedido of pedidosPorStatus().pronto; track pedido.id) {
                <div class="pedido-card pronto" [class.card-clicavel]="pedido.latitude && pedido.longitude"
                  [attr.role]="pedido.latitude && pedido.longitude ? 'button' : null"
                  [attr.tabindex]="pedido.latitude && pedido.longitude ? 0 : null"
                  (click)="abrirRotaParaEntrega(pedido)" (keydown)="abrirRotaComTeclado($event, pedido)"
                  [title]="pedido.latitude && pedido.longitude ? 'Clique ou pressione Enter para abrir rota no Google Maps' : 'Endere√ßo sem coordenadas - n√£o √© poss√≠vel abrir rota'">
                  <div class="pedido-header">
                    <div class="pedido-numero-wrapper">
                      <span class="pedido-numero">#{{ pedido.numeroPedido }}</span>
                    </div>
                    <div class="pedido-cliente-wrapper">
                      <span class="pedido-cliente">{{ pedido.clienteNome }}</span>
                    </div>
                  </div>
                  @if (pedido.enderecoEntrega) {
                  <div class="pedido-endereco">
                    üìç {{ pedido.enderecoEntrega }}
                  </div>
                  }
                  <div class="pedido-valor-pedido">
                    Pedido: {{ formatarValor(pedido.valorTotal) }}
                  </div>
                  @if (pedido.valorMotoboy) {
                  <div class="pedido-valor-entrega">
                    <span class="valor-motoboy-label">Valor entrega:</span>
                    <span class="valor-motoboy-valor">{{ formatarValor(pedido.valorMotoboy) }}</span>
                  </div>
                  }
                  <div class="pedido-acoes">
                    <button class="btn-acao btn-saiu-entrega"
                      (click)="$event.stopPropagation(); marcarComoSaiuParaEntrega(pedido)"
                      title="Marcar como saiu para entrega">
                      üöö Saiu para Entrega
                    </button>
                  </div>
                </div>
                }
              </div>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Quadro: Finalizados -->
    <div class="kanban-quadro">
      <div class="quadro-header">
        <h3 class="quadro-titulo">‚úîÔ∏è Finalizados</h3>
      </div>
      <div class="quadro-conteudo">
        @if (pedidosPorStatus().finalizados.length === 0) {
        <div class="sem-pedidos-mensagem">
          <p>Voc√™ n√£o tem pedidos finalizados</p>
        </div>
        } @else {
        <div class="pedidos-lista-finalizados">
          @for (pedido of pedidosPorStatus().finalizados; track pedido.id) {
          <div class="pedido-card finalizado" [class.card-clicavel]="pedido.latitude && pedido.longitude"
            [attr.role]="pedido.latitude && pedido.longitude ? 'button' : null"
            [attr.tabindex]="pedido.latitude && pedido.longitude ? 0 : null" (click)="abrirRotaParaEntrega(pedido)"
            [title]="pedido.latitude && pedido.longitude ? 'Clique para ver detalhes' : 'Endere√ßo sem coordenadas'">
            <div class="pedido-header">
              <div class="pedido-numero-wrapper">
                <span class="pedido-numero">#{{ pedido.numeroPedido }}</span>
              </div>
              <div class="pedido-cliente-wrapper">
                <span class="pedido-cliente">{{ pedido.clienteNome }}</span>
              </div>
            </div>
            @if (pedido.enderecoEntrega) {
            <div class="pedido-endereco">
              üìç {{ pedido.enderecoEntrega }}
            </div>
            }
            <div class="pedido-valor-pedido">
              Pedido: {{ formatarValor(pedido.valorTotal) }}
            </div>
            @if (pedido.valorMotoboy) {
            <div class="pedido-valor-entrega">
              <span class="valor-motoboy-label">Valor entrega:</span>
              <span class="valor-motoboy-valor">{{ formatarValor(pedido.valorMotoboy) }}</span>
            </div>
            }
            @if (pedido.updatedAt) {
            <div class="pedido-tempo">
              <span class="tempo-label">Finalizado em: {{ formatarData(pedido.updatedAt) }}</span>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
    </div>
  </div>
  }
</div>

<!-- Modal de Mapa -->
<app-modal-mapa-entrega [aberto]="modalMapaAberto()" [latitude]="pedidoSelecionado()?.latitude ?? null"
  [longitude]="pedidoSelecionado()?.longitude ?? null" [enderecoEntrega]="pedidoSelecionado()?.enderecoEntrega ?? ''"
  [numeroPedido]="pedidoSelecionado()?.numeroPedido ?? ''" [statusPedido]="pedidoSelecionado()?.status ?? ''"
  (onFechar)="fecharModalMapa()" (onMarcarComoEntregue)="marcarComoEntregueNoModal()">
</app-modal-mapa-entrega>