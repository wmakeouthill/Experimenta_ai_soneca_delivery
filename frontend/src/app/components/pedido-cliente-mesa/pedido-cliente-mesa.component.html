<div class="pedido-cliente-container" [class.sucesso]="etapaAtual() === 'sucesso'">
    <!-- Carregando Mesa -->
    @if (carregando()) {
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Carregando...</p>
        </div>
    }

    <!-- Erro -->
    @if (erro() && !carregando()) {
        <div class="error-screen">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Oops!</h2>
            <p>{{ erro() }}</p>
        </div>
    }

    <!-- ========== ETAPA 1: IDENTIFICA√á√ÉO ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'identificacao' && mesa()) {
        <div class="identificacao-screen">
            <div class="identificacao-header">
                <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-grande">
                <h1>Bem-vindo!</h1>
                <p class="mesa-badge">Mesa {{ mesa()!.numero }}</p>
            </div>

            <div class="identificacao-form">
                <h2>Digite seu telefone</h2>
                <p class="form-hint">Usamos para identificar voc√™ e seus pedidos</p>

                <div class="input-group">
                    <input
                        type="tel"
                        [(ngModel)]="telefoneInputValue"
                        placeholder="(00) 00000-0000"
                        class="input-telefone"
                        [class.valido]="identificacao.telefoneValido()"
                        maxlength="15"
                        inputmode="numeric">
                </div>

                @if (identificacao.erro()) {
                    <p class="erro-msg">{{ identificacao.erro() }}</p>
                }

                <button
                    class="btn-continuar"
                    [disabled]="!identificacao.podeBuscar()"
                    (click)="buscarCliente()">
                    @if (identificacao.buscando()) {
                        <span class="spinner-mini"></span> Buscando...
                    } @else {
                        Continuar
                    }
                </button>

                <!-- Divisor -->
                <div class="divisor-ou">
                    <span>ou</span>
                </div>

                <!-- Container para Bot√£o Oficial do Google -->
                <div class="google-button-container">
                    <div #googleButtonLogin class="google-signin-button"></div>
                    @if (googleAuth.clienteAuth.carregando()) {
                        <div class="google-loading-overlay">
                            <span class="spinner-mini"></span> Entrando...
                        </div>
                    }
                </div>

                @if (googleAuth.clienteAuth.erro()) {
                    <p class="erro-msg">{{ googleAuth.clienteAuth.erro() }}</p>
                }
            </div>
        </div>
    }

    <!-- ========== ETAPA 2: CADASTRO (Novo Cliente) ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'cadastro' && mesa()) {
        <div class="identificacao-screen">
            <div class="identificacao-header">
                <img src="/assets/experimenta_ai_banner_circular.png" alt="Logo" class="logo-grande">
                <h1>Novo por aqui?</h1>
                <p class="mesa-badge">Mesa {{ mesa()!.numero }}</p>
            </div>

            <div class="identificacao-form">
                <h2>Complete seu cadastro</h2>
                <p class="form-hint">Precisamos de algumas informa√ß√µes para continuar</p>

                <div class="input-group">
                    <label>Telefone</label>
                    <input
                        type="tel"
                        [value]="identificacao.getTelefone()"
                        disabled
                        class="input-telefone disabled">
                </div>

                <div class="input-group">
                    <label>Seu nome</label>
                    <input
                        type="text"
                        [(ngModel)]="nomeInputValue"
                        placeholder="Como podemos te chamar?"
                        class="input-nome"
                        [class.valido]="identificacao.nomeValido()"
                        maxlength="100">
                </div>

                @if (identificacao.erro()) {
                    <p class="erro-msg">{{ identificacao.erro() }}</p>
                }

                <button
                    class="btn-continuar"
                    [disabled]="!identificacao.podeCadastrar()"
                    (click)="cadastrarCliente()">
                    @if (identificacao.buscando()) {
                        <span class="spinner-mini"></span> Cadastrando...
                    } @else {
                        Come√ßar a pedir
                    }
                </button>

                <button class="btn-voltar" (click)="voltarParaIdentificacao()">
                    ‚Üê Voltar
                </button>
            </div>
        </div>
    }

    <!-- ========== ETAPA 3: CARD√ÅPIO ========== -->
    @if (!carregando() && !erro() && etapaAtual() === 'cardapio' && mesa() && identificacao.clienteIdentificado()) {
        @if (mostrarBannerPwa()) {
            <div class="pwa-install-banner">
                <div class="pwa-install-texto">
                    <strong>Instale o app</strong>
                    <span>Atalho na tela inicial, experi√™ncia fullscreen e mais r√°pida.</span>
                </div>
                <div class="pwa-install-botoes">
                    <button class="pwa-btn-secundario" (click)="fecharBannerPwa($event)">Agora n√£o</button>
                    <button class="pwa-btn-primario" (click)="instalarPwa($event)">Adicionar</button>
                </div>
            </div>
        }
        <!-- Header fixo -->
        <header class="header-cliente">
            <div class="header-content">
                <img src="/assets/experimenta_ai_banner_circular.webp" alt="Logo" class="logo-mini">
                <div class="header-info">
                    <span class="cliente-nome">Ol√°, {{ identificacao.clienteIdentificado()!.nome.split(' ')[0] }}!</span>
                    <span class="mesa-label">Mesa {{ mesa()!.numero }}</span>
                </div>
            </div>
        </header>

        <!-- Carregando card√°pio -->
        @if (cardapio.carregando()) {
            <div class="loading-cardapio">
                <div class="loading-spinner"></div>
                <p>Carregando card√°pio...</p>
            </div>
        } @else {
            <!-- ========== ABA: IN√çCIO ========== -->
            @if (abaAtual() === 'inicio') {
                <div class="aba-inicio">
                    <!-- Mais Pedidos -->
                    <div class="inicio-section">
                        <h2 class="section-titulo">üî• Mais Pedidos</h2>
                        @if (inicio.carregando()) {
                            <div class="carrossel-loading">Carregando...</div>
                        } @else if (inicio.produtosMaisPedidos().length > 0) {
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosMaisPedidos(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        } @else {
                            <p class="carrossel-vazio">Nenhum produto ainda. Fa√ßa seu primeiro pedido!</p>
                        }
                    </div>

                    <!-- Favoritos de Sempre (mais favoritados por todos os clientes) -->
                    @if (inicio.temMaisFavoritados()) {
                        <div class="inicio-section">
                            <h2 class="section-titulo">üíñ Favoritos de Sempre</h2>
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosMaisFavoritados(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            @if (produto.quantidadeFavoritos) {
                                                <span class="produto-pedidos">{{ produto.quantidadeFavoritos }} ‚ù§Ô∏è</span>
                                            }
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- Mais Bem Avaliados -->
                    <div class="inicio-section">
                        <h2 class="section-titulo">‚≠ê Mais Bem Avaliados</h2>
                        @if (inicio.carregando()) {
                            <div class="carrossel-loading">Carregando...</div>
                        } @else if (inicio.produtosBemAvaliados().length > 0) {
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of inicio.produtosBemAvaliados(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button
                                            class="btn-favorito"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            @if (produto.mediaAvaliacao) {
                                                <span class="produto-avaliacao">‚≠ê {{ produto.mediaAvaliacao.toFixed(1) }}</span>
                                            }
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        } @else {
                            <p class="carrossel-vazio">Nenhum produto avaliado ainda.</p>
                        }
                    </div>

                    <!-- Meus Favoritos -->
                    @if (favoritos.produtosFavoritos().length > 0) {
                        <div class="inicio-section">
                            <h2 class="section-titulo">‚ù§Ô∏è Meus Favoritos</h2>
                            <div class="carrossel-horizontal" appDraggableScroll>
                                @for (produto of favoritos.produtosFavoritos(); track produto.id) {
                                    <div class="produto-card-mini" (click)="abrirDetalhesProduto(produto)">
                                        <button class="btn-favorito ativo" (click)="toggleFavorito(produto.id, $event)" title="Remover dos favoritos">
                                            ‚ù§Ô∏è
                                        </button>
                                        @if (produto.foto) {
                                            <div class="produto-imagem-mini">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem-mini produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info-mini">
                                            <span class="produto-nome-mini">{{ produto.nome }}</span>
                                            <span class="produto-preco-mini">{{ formatarPreco(produto.preco) }}</span>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="inicio-categorias">
                        <h2 class="section-titulo">üìÇ Categorias</h2>
                        <div class="categorias-grid">
                            @for (categoria of cardapio.categorias(); track categoria.id) {
                                <button class="categoria-card" (click)="cardapio.selecionarCategoria(categoria.nome); navegarPara('cardapio')">
                                    <span class="categoria-nome">{{ categoria.nome }}</span>
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }

            <!-- ========== ABA: CARD√ÅPIO ========== -->
            @if (abaAtual() === 'cardapio') {
            <!-- Categorias -->
            <div class="categorias-scroll">
                <button
                    class="categoria-chip"
                    [class.ativa]="cardapio.categoriaSelecionada() === null"
                    (click)="cardapio.selecionarCategoria(null)">
                    üçΩÔ∏è Todos
                </button>
                @for (categoria of cardapio.categorias(); track categoria.id) {
                    <button
                        class="categoria-chip"
                        [class.ativa]="cardapio.categoriaSelecionada() === categoria.nome"
                        (click)="cardapio.selecionarCategoria(categoria.nome)">
                        {{ categoria.nome }}
                    </button>
                }
            </div>

            <!-- Lista de Produtos -->
            <div class="produtos-container">
                <!-- Exibi√ß√£o agrupada por categoria (quando "Todos" selecionado) -->
                @if (cardapio.categoriaSelecionada() === null) {
                    @for (grupo of cardapio.produtosAgrupadosPorCategoria(); track grupo.id) {
                        <div class="categoria-section">
                            <h2 class="categoria-titulo">{{ grupo.nome }}</h2>
                            <div class="produtos-grid">
                                @for (produto of grupo.produtos; track produto.id) {
                                    <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                                        @if (produto.foto) {
                                            <div class="produto-imagem">
                                                <img [src]="produto.foto" [alt]="produto.nome">
                                            </div>
                                        } @else {
                                            <div class="produto-imagem produto-sem-foto">
                                                <span>üçΩÔ∏è</span>
                                            </div>
                                        }
                                        <div class="produto-info">
                                            <h3 class="produto-nome">{{ produto.nome }}</h3>
                                            @if (produto.descricao) {
                                                <p class="produto-descricao">{{ produto.descricao }}</p>
                                            }
                                            <div class="produto-preco">{{ formatarPreco(produto.preco) }}</div>
                                            <div class="produto-acoes">
                                                <button
                                                    class="btn-favorito btn-favorito-inline"
                                                    [class.ativo]="favoritos.isFavorito(produto.id)"
                                                    (click)="toggleFavorito(produto.id, $event)"
                                                    [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                                    {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                                </button>
                                                <button
                                                    class="btn-adicionar"
                                                    (click)="adicionarAoCarrinhoRapido(produto); $event.stopPropagation()"
                                                    aria-label="Adicionar ao carrinho">
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    } @empty {
                        <div class="sem-produtos">
                            <p>Nenhum produto dispon√≠vel</p>
                        </div>
                    }
                } @else {
                    <!-- Exibi√ß√£o normal (categoria espec√≠fica selecionada) -->
                    <div class="produtos-grid">
                        @for (produto of cardapio.produtosFiltrados(); track produto.id) {
                            <div class="produto-card" (click)="abrirDetalhesProduto(produto)">
                                @if (produto.foto) {
                                    <div class="produto-imagem">
                                        <img [src]="produto.foto" [alt]="produto.nome">
                                    </div>
                                } @else {
                                    <div class="produto-imagem produto-sem-foto">
                                        <span>üçΩÔ∏è</span>
                                    </div>
                                }
                                <div class="produto-info">
                                    <h3 class="produto-nome">{{ produto.nome }}</h3>
                                    @if (produto.descricao) {
                                        <p class="produto-descricao">{{ produto.descricao }}</p>
                                    }
                                    <div class="produto-preco">{{ formatarPreco(produto.preco) }}</div>
                                    <div class="produto-acoes">
                                        <button
                                            class="btn-favorito btn-favorito-inline"
                                            [class.ativo]="favoritos.isFavorito(produto.id)"
                                            (click)="toggleFavorito(produto.id, $event)"
                                            [title]="favoritos.isFavorito(produto.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'">
                                            {{ favoritos.isFavorito(produto.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                        </button>
                                        <button
                                            class="btn-adicionar"
                                            (click)="adicionarAoCarrinhoRapido(produto); $event.stopPropagation()"
                                            aria-label="Adicionar ao carrinho">
                                            +
                                        </button>
                                    </div>
                                </div>
                            </div>
                        } @empty {
                            <div class="sem-produtos">
                                <p>Nenhum produto dispon√≠vel nesta categoria</p>
                            </div>
                        }
                    </div>
                }
            </div>
            } <!-- Fecha @if abaAtual() === 'cardapio' -->

            <!-- ========== ABA: PERFIL ========== -->
            @if (abaAtual() === 'perfil') {
                <div class="aba-perfil">
                    <!-- Se√ß√£o Principal do Perfil -->
                    @if (secaoPerfil() === 'principal') {
                        <div class="perfil-header">
                            <div class="perfil-avatar">
                                @if (googleAuth.clienteAuth.cliente()?.fotoUrl) {
                                    <img [src]="getFotoUrlComProxy(googleAuth.clienteAuth.cliente()!.fotoUrl) || ''"
                                         alt="Foto"
                                         class="avatar-img"
                                         (error)="onImageError($event)">
                                } @else {
                                    <span class="avatar-placeholder">üë§</span>
                                }
                            </div>
                            <h2 class="perfil-nome">{{ identificacao.clienteIdentificado()!.nome }}</h2>
                            @if (identificacao.clienteIdentificado()!.telefone) {
                                <p class="perfil-telefone">{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</p>
                            }
                            @if (googleAuth.clienteAuth.cliente()?.email) {
                                <p class="perfil-email">{{ googleAuth.clienteAuth.cliente()!.email }}</p>
                            }
                        </div>

                        <div class="perfil-menu">
                            @if (podeInstalarPwa()) {
                                <button class="perfil-item pwa-instalar" (click)="instalarPwa($event)">
                                    <span class="item-icon">üì≤</span>
                                    <span class="item-texto">Adicionar como app</span>
                                    <span class="item-arrow">‚Ä∫</span>
                                </button>
                            }

                            <!-- Vincular/Desvincular Google -->
                            @if (googleAuth.clienteAuth.cliente()?.googleVinculado) {
                                <button class="perfil-item google-vinculado" (click)="desvincularGoogle()">
                                    <span class="item-icon">
                                        <svg viewBox="0 0 24 24" width="20" height="20">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                    </span>
                                    <span class="item-texto">Google vinculado</span>
                                    <span class="item-badge vinculado">‚úì</span>
                                </button>
                            } @else {
                                <button class="perfil-item google-vincular" (click)="vincularGoogle()" [disabled]="googleAuth.clienteAuth.carregando()">
                                    <span class="item-icon">
                                        <svg viewBox="0 0 24 24" width="20" height="20">
                                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                                        </svg>
                                    </span>
                                    <span class="item-texto">Vincular com Google</span>
                                    <span class="item-arrow">‚Ä∫</span>
                                </button>
                            }

                            <!-- Adicionar/Editar Celular -->
                            <button class="perfil-item" (click)="secaoPerfil.set('celular')">
                                <span class="item-icon">üì±</span>
                                <span class="item-texto">
                                    @if (googleAuth.clienteAuth.cliente()?.telefone) {
                                        Meu celular
                                    } @else {
                                        Adicionar celular
                                    }
                                </span>
                                @if (googleAuth.clienteAuth.cliente()?.telefone) {
                                    <span class="item-badge telefone">{{ googleAuth.clienteAuth.cliente()!.telefone }}</span>
                                }
                                <span class="item-arrow">‚Ä∫</span>
                            </button>

                            <button class="perfil-item" (click)="trocarCliente()">
                                <span class="item-icon">üîÑ</span>
                                <span class="item-texto">Trocar conta</span>
                                <span class="item-arrow">‚Ä∫</span>
                            </button>
                            <button class="perfil-item" (click)="secaoPerfil.set('favoritos')">
                                <span class="item-icon">‚≠ê</span>
                                <span class="item-texto">Favoritos</span>
                                @if (favoritos.produtosFavoritos().length > 0) {
                                    <span class="item-count">{{ favoritos.produtosFavoritos().length }}</span>
                                }
                                <span class="item-arrow">‚Ä∫</span>
                            </button>
                            <button class="perfil-item" (click)="irParaMeusPedidos()">
                                <span class="item-icon">üìã</span>
                                <span class="item-texto">Meus Pedidos</span>
                                <span class="item-arrow">‚Ä∫</span>
                            </button>
                            <button class="perfil-item" (click)="secaoPerfil.set('senha')">
                                <span class="item-icon">üîí</span>
                                <span class="item-texto">
                                    @if (identificacao.clienteIdentificado()?.temSenha) {
                                        Alterar Senha
                                    } @else {
                                        Criar Senha
                                    }
                                </span>
                                <span class="item-arrow">‚Ä∫</span>
                            </button>
                        </div>

                        @if (googleAuth.clienteAuth.erro()) {
                            <p class="erro-msg">{{ googleAuth.clienteAuth.erro() }}</p>
                        }

                        <p class="perfil-info">Mesa {{ mesa()!.numero }}</p>
                    }

                    <!-- Se√ß√£o Favoritos -->
                    @if (secaoPerfil() === 'favoritos') {
                        <div class="secao-header">
                            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                                <span>‚Äπ</span>
                            </button>
                            <h2 class="secao-titulo">Favoritos</h2>
                        </div>

                        <div class="lista-favoritos">
                            @if (favoritos.produtosFavoritos().length === 0) {
                                <div class="lista-vazia">
                                    <span class="lista-vazia-icon">‚≠ê</span>
                                    <p>Nenhum item favorito ainda</p>
                                    <small>Toque no ‚ù§Ô∏è em um produto para favorit√°-lo</small>
                                </div>
                            } @else {
                                @for (produto of favoritos.produtosFavoritos(); track produto.id) {
                                    <div class="item-favorito">
                                        <div class="item-img-container">
                                            @if (produto.foto) {
                                                <img [src]="produto.foto" [alt]="produto.nome" class="item-img">
                                            } @else {
                                                <div class="item-img-placeholder">üçΩÔ∏è</div>
                                            }
                                        </div>
                                        <div class="item-info">
                                            <h4 class="item-nome">{{ produto.nome }}</h4>
                                            <p class="item-preco">{{ produto.preco | currency:'BRL' }}</p>
                                        </div>
                                        <div class="item-acoes">
                                            <button class="btn-adicionar-fav" (click)="adicionarAoCarrinhoRapido(produto)">
                                                <span>+</span>
                                            </button>
                                            <button class="btn-remover-fav" (click)="favoritos.remover(produto.id)">
                                                <span>üóëÔ∏è</span>
                                            </button>
                                        </div>
                                    </div>
                                }
                            }
                        </div>
                    }

                    <!-- Se√ß√£o Meus Pedidos -->
                    @if (secaoPerfil() === 'pedidos') {
                        <div class="secao-header">
                            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                                <span>‚Äπ</span>
                            </button>
                            <h2 class="secao-titulo">Meus Pedidos</h2>
                        </div>

                        <div class="lista-pedidos">
                            @if (meusPedidos.carregando() && meusPedidos.pedidos().length === 0) {
                                <div class="lista-carregando">
                                    <span class="spinner"></span>
                                    <p>Carregando pedidos...</p>
                                </div>
                            } @else if (meusPedidos.pedidos().length === 0) {
                                <div class="lista-vazia">
                                    <span class="lista-vazia-icon">üìã</span>
                                    <p>Nenhum pedido realizado ainda</p>
                                    <small>Seus pedidos aparecer√£o aqui</small>
                                </div>
                            } @else {
                                @for (pedido of meusPedidos.pedidos(); track pedido.id) {
                                    <div class="item-pedido clicavel" (click)="meusPedidos.selecionarPedido(pedido)">
                                        <div class="pedido-header">
                                            <span class="pedido-data">{{ pedido.dataHoraPedido | date:'dd/MM/yyyy HH:mm' }}</span>
                                            <span class="pedido-status" [class]="'status-' + pedido.status.toLowerCase()">
                                                {{ pedido.statusDescricao }}
                                            </span>
                                        </div>
                                        <div class="pedido-itens">
                                            @for (item of pedido.itens; track item.produtoId) {
                                                <div class="pedido-item-container">
                                                    <span class="pedido-item">{{ item.quantidade }}x {{ item.nomeProduto }}</span>
                                                    @if (item.adicionais && item.adicionais.length > 0) {
                                                        <span class="pedido-adicionais-resumo">
                                                            (+ @for (ad of item.adicionais; track ad.adicionalId; let isLast = $last) {
                                                                {{ ad.quantidade }}x {{ ad.nome }}{{ isLast ? '' : ', ' }}
                                                            })
                                                        </span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                        <div class="pedido-footer">
                                            <span class="pedido-total">{{ pedido.valorTotal | currency:'BRL' }}</span>
                                            <div class="pedido-footer-right">
                                                @if (pedido.numeroMesa) {
                                                    <span class="pedido-mesa">Mesa {{ pedido.numeroMesa }}</span>
                                                }
                                                <span class="pedido-ver-mais">Ver detalhes ‚Ä∫</span>
                                            </div>
                                        </div>
                                    </div>
                                }

                                @if (meusPedidos.temMais()) {
                                    <button class="btn-carregar-mais"
                                            (click)="meusPedidos.carregarMais()"
                                            [disabled]="meusPedidos.carregando()">
                                        @if (meusPedidos.carregando()) {
                                            <span class="spinner-sm"></span>
                                        } @else {
                                            Ver mais pedidos
                                        }
                                    </button>
                                }
                            }
                        </div>

                        <!-- Modal Detalhes do Pedido -->
                        @if (meusPedidos.mostrandoDetalhes() && meusPedidos.pedidoSelecionado()) {
                            <div class="modal-overlay" (click)="meusPedidos.fecharDetalhes()">
                                <div class="modal-detalhes-pedido" (click)="$event.stopPropagation()">
                                    <div class="modal-header">
                                        <h3>Pedido #{{ meusPedidos.pedidoSelecionado()?.numeroPedido }}</h3>
                                        <button class="btn-fechar-modal" (click)="meusPedidos.fecharDetalhes()">‚úï</button>
                                    </div>

                                    <div class="modal-body">
                                        <div class="detalhes-info">
                                            <div class="info-row">
                                                <span class="info-label">Data:</span>
                                                <span class="info-value">{{ meusPedidos.pedidoSelecionado()?.dataHoraPedido | date:'dd/MM/yyyy HH:mm' }}</span>
                                            </div>
                                            <div class="info-row">
                                                <span class="info-label">Status:</span>
                                                <span class="info-value pedido-status" [class]="'status-' + meusPedidos.pedidoSelecionado()?.status?.toLowerCase()">
                                                    {{ meusPedidos.pedidoSelecionado()?.statusDescricao }}
                                                </span>
                                            </div>
                                            @if (meusPedidos.pedidoSelecionado()?.numeroMesa) {
                                                <div class="info-row">
                                                    <span class="info-label">Mesa:</span>
                                                    <span class="info-value">{{ meusPedidos.pedidoSelecionado()?.numeroMesa }}</span>
                                                </div>
                                            }
                                        </div>

                                        <div class="detalhes-itens">
                                            <h4>Itens do Pedido</h4>
                                            @for (item of meusPedidos.pedidoSelecionado()?.itens; track item.produtoId) {
                                                <div class="detalhe-item">
                                                    <div class="detalhe-item-header">
                                                        <div class="item-info">
                                                            <span class="item-qtd">{{ item.quantidade }}x</span>
                                                            <span class="item-nome">{{ item.nomeProduto }}</span>
                                                        </div>
                                                        <span class="item-preco">{{ item.subtotal | currency:'BRL' }}</span>
                                                    </div>
                                                    @if (item.adicionais && item.adicionais.length > 0) {
                                                        <div class="item-adicionais-detalhe">
                                                            @for (ad of item.adicionais; track ad.adicionalId) {
                                                                <span class="adicional-detalhe">+{{ ad.quantidade }}x {{ ad.nome }} ({{ ad.subtotal | currency:'BRL' }})</span>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>

                                        <div class="detalhes-total">
                                            <span>Total:</span>
                                            <strong>{{ meusPedidos.pedidoSelecionado()?.valorTotal | currency:'BRL' }}</strong>
                                        </div>

                                        <!-- Se√ß√£o de Avalia√ß√£o -->
                                        @if (meusPedidos.pedidoSelecionado()?.status === 'FINALIZADO') {
                                            <div class="secao-avaliacao">
                                                <!-- Se j√° avaliou e n√£o est√° editando: mostra resumo -->
                                                @if (avaliacao.pedidoJaAvaliado() && !avaliacao.isEditando()) {
                                                    <div class="avaliacao-resumo">
                                                        <div class="avaliacao-resumo-header">
                                                            <div class="avaliacao-resumo-info">
                                                                <span class="avaliacao-resumo-titulo">Sua avalia√ß√£o</span>
                                                                <div class="avaliacao-resumo-estrelas">
                                                                    @for (estrela of [1, 2, 3, 4, 5]; track estrela) {
                                                                        <span class="estrela-resumo" [class.ativa]="avaliacao.getMediaAvaliacaoPedido() >= estrela">
                                                                            {{ avaliacao.getMediaAvaliacaoPedido() >= estrela ? '‚òÖ' : '‚òÜ' }}
                                                                        </span>
                                                                    }
                                                                </div>
                                                            </div>
                                                            <button class="btn-editar-avaliacao" (click)="avaliacao.entrarModoEdicao()">
                                                                ‚úèÔ∏è Editar
                                                            </button>
                                                        </div>

                                                        <!-- Avalia√ß√µes individuais dos itens -->
                                                        <div class="avaliacao-itens-resumo">
                                                            @for (item of meusPedidos.pedidoSelecionado()?.itens; track item.produtoId) {
                                                                <div class="item-avaliacao-resumo">
                                                                    <span class="item-nome-resumo">{{ item.nomeProduto }}</span>
                                                                    <div class="estrelas-mini">
                                                                        @for (estrela of [1, 2, 3, 4, 5]; track estrela) {
                                                                            <span class="estrela-mini" [class.ativa]="avaliacao.getAvaliacaoProduto(item.produtoId) >= estrela">‚òÖ</span>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>

                                                        @if (avaliacao.getComentarioPedido()) {
                                                            <div class="avaliacao-comentario-salvo">
                                                                <span class="comentario-label">üí¨ Seu coment√°rio:</span>
                                                                <p class="comentario-texto">"{{ avaliacao.getComentarioPedido() }}"</p>
                                                            </div>
                                                        }
                                                    </div>
                                                } @else {
                                                    <!-- Modo de edi√ß√£o ou primeira avalia√ß√£o -->
                                                    <div class="avaliacao-edicao">
                                                        <div class="avaliacao-edicao-header">
                                                            <h4>‚≠ê Avalie este pedido</h4>
                                                            @if (avaliacao.pedidoJaAvaliado()) {
                                                                <span class="avaliacao-modo-edicao">Editando</span>
                                                            }
                                                        </div>

                                                        <div class="itens-avaliacao-lista">
                                                            @for (item of meusPedidos.pedidoSelecionado()?.itens; track item.produtoId) {
                                                                <div class="item-avaliacao">
                                                                    <span class="item-nome-avaliacao">{{ item.nomeProduto }}</span>
                                                                    <div class="estrelas-avaliacao">
                                                                        @for (estrela of [1, 2, 3, 4, 5]; track estrela) {
                                                                            <button class="estrela-btn"
                                                                                    [class.ativa]="avaliacao.getAvaliacaoProduto(item.produtoId) >= estrela"
                                                                                    (click)="avaliacao.avaliarProduto(item.produtoId, estrela)">
                                                                                {{ avaliacao.getAvaliacaoProduto(item.produtoId) >= estrela ? '‚òÖ' : '‚òÜ' }}
                                                                            </button>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            }
                                                        </div>

                                                        <!-- Campo de coment√°rio -->
                                                        <div class="comentario-avaliacao">
                                                            <label for="comentarioPedido">üí¨ Coment√°rio (opcional)</label>
                                                            <textarea
                                                                id="comentarioPedido"
                                                                [value]="avaliacao.getComentarioPedido()"
                                                                (input)="avaliacao.setComentarioPedido($any($event.target).value)"
                                                                placeholder="Conte-nos sobre sua experi√™ncia..."
                                                                rows="3"
                                                                class="textarea-comentario"
                                                                [disabled]="avaliacao.salvando()"
                                                            ></textarea>
                                                        </div>

                                                        <!-- Bot√£o Enviar Avalia√ß√£o -->
                                                        <button
                                                            class="btn-enviar-avaliacao"
                                                            (click)="avaliacao.enviarAvaliacao()"
                                                            [disabled]="avaliacao.salvando() || !avaliacao.temAlgumaAvaliacao()">
                                                            @if (avaliacao.salvando()) {
                                                                ‚è≥ Enviando...
                                                            } @else {
                                                                ‚úì Enviar Avalia√ß√£o
                                                            }
                                                        </button>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>

                                    <div class="modal-footer">
                                        @if (meusPedidos.pedidoSelecionado()?.status !== 'FINALIZADO' && meusPedidos.pedidoSelecionado()?.status !== 'CANCELADO') {
                                            <button class="btn-ver-status" (click)="verStatusPedido(meusPedidos.pedidoSelecionado()!.id)">
                                                üìç Ver Status do Pedido
                                            </button>
                                        }
                                        <button class="btn-fechar" (click)="meusPedidos.fecharDetalhes()">Fechar</button>
                                    </div>
                                </div>
                            </div>
                        }
                    }

                    <!-- Se√ß√£o Criar/Alterar Senha -->
                    @if (secaoPerfil() === 'senha') {
                        <div class="secao-header">
                            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                                <span>‚Äπ</span>
                            </button>
                            <h2 class="secao-titulo">
                                @if (identificacao.clienteIdentificado()?.temSenha) {
                                    Alterar Senha
                                } @else {
                                    Criar Senha
                                }
                            </h2>
                        </div>

                        <div class="secao-senha">
                            <p class="senha-info">
                                @if (identificacao.clienteIdentificado()?.temSenha) {
                                    Com sua senha, voc√™ pode fazer login usando seu telefone + senha, sem precisar do Google.
                                } @else {
                                    Crie uma senha para poder fazer login usando seu telefone, sem precisar do Google.
                                }
                            </p>

                            @if (identificacao.clienteIdentificado()?.temSenha) {
                                <div class="form-grupo">
                                    <label>Senha Atual</label>
                                    <input type="password"
                                           [(ngModel)]="senhaAtual"
                                           placeholder="Digite sua senha atual"
                                           class="input-senha">
                                </div>
                            }

                            <div class="form-grupo">
                                <label>Nova Senha</label>
                                <input type="password"
                                       [(ngModel)]="novaSenha"
                                       placeholder="M√≠nimo 6 caracteres"
                                       minlength="6"
                                       class="input-senha">
                            </div>

                            <div class="form-grupo">
                                <label>Confirmar Nova Senha</label>
                                <input type="password"
                                       [(ngModel)]="confirmarSenha"
                                       placeholder="Digite novamente"
                                       class="input-senha">
                            </div>

                            @if (erroSenha()) {
                                <p class="erro-msg">{{ erroSenha() }}</p>
                            }

                            <button class="btn-salvar-senha"
                                    (click)="salvarSenha()"
                                    [disabled]="salvandoSenha()">
                                @if (salvandoSenha()) {
                                    <span class="spinner-sm"></span>
                                    Salvando...
                                } @else {
                                    Salvar Senha
                                }
                            </button>
                        </div>
                    }

                    <!-- Se√ß√£o Adicionar/Editar Celular -->
                    @if (secaoPerfil() === 'celular') {
                        <div class="secao-header">
                            <button class="btn-voltar" (click)="secaoPerfil.set('principal')">
                                <span>‚Äπ</span>
                            </button>
                            <h2 class="secao-titulo">
                                @if (googleAuth.clienteAuth.cliente()?.telefone) {
                                    Editar Celular
                                } @else {
                                    Adicionar Celular
                                }
                            </h2>
                        </div>

                        <div class="secao-celular">
                            <p class="celular-info">
                                @if (googleAuth.clienteAuth.cliente()?.telefone) {
                                    Atualize seu n√∫mero de celular para facilitar sua identifica√ß√£o.
                                } @else {
                                    Adicione seu celular para poder fazer login mais r√°pido e receber novidades.
                                }
                            </p>

                            <div class="form-grupo">
                                <label>N√∫mero do Celular</label>
                                <input type="tel"
                                       [ngModel]="celularInput()"
                                       (ngModelChange)="celularInput.set($event)"
                                       placeholder="(00) 00000-0000"
                                       inputmode="numeric"
                                       maxlength="15"
                                       class="input-celular">
                            </div>

                            @if (celularErro()) {
                                <p class="erro-msg">{{ celularErro() }}</p>
                            }

                            @if (celularSucesso()) {
                                <p class="sucesso-msg">‚úì Celular salvo com sucesso!</p>
                            }

                            <button class="btn-salvar-celular"
                                    (click)="salvarCelular()"
                                    [disabled]="celularSalvando() || celularSucesso()">
                                @if (celularSalvando()) {
                                    <span class="spinner-sm"></span>
                                    Salvando...
                                } @else if (celularSucesso()) {
                                    ‚úì Salvo!
                                } @else {
                                    Salvar Celular
                                }
                            </button>
                        </div>
                    }
                </div>
            }
        }

        <!-- ========== CTAs DE NOTIFICA√á√ÉO ========== -->
        <div class="ctas-container">
            <!-- CTA Avalia√ß√£o -->
            @if (temPedidosNaoAvaliados() && (abaAtual() === 'inicio' || abaAtual() === 'perfil')) {
                <div class="cta-avaliacao" (click)="irParaMeusPedidos(); navegarPara('perfil')">
                    <span class="cta-icon">‚≠ê</span>
                    <span class="cta-texto">Avalie seus pedidos em <strong>Meus Pedidos</strong></span>
                    <span class="cta-seta">‚Ä∫</span>
                </div>
            }

            <!-- CTA Preencher Telefone -->
            @if (!googleAuth.clienteAuth.cliente()?.telefone && (abaAtual() === 'inicio' || abaAtual() === 'perfil') && secaoPerfil() === 'principal') {
                <div class="cta-telefone" (click)="abrirEdicaoCelular(); navegarPara('perfil')">
                    <span class="cta-icon">üì±</span>
                    <span class="cta-texto">Cadastre seu celular para <strong>facilitar o atendimento</strong></span>
                    <span class="cta-seta">‚Ä∫</span>
                </div>
            }
        </div>

        <!-- ========== CTA PEDIDO ATIVO ========== -->
        @if (mostrarCtaPedidoAtivo()) {
            <div class="cta-pedido-ativo" (click)="verStatusPedidoAtivo()">
                <div class="cta-pedido-ativo-content">
                    <span class="cta-pedido-ativo-icon">üçΩÔ∏è</span>
                    <div class="cta-pedido-ativo-texto">
                        <strong>Pedido em andamento</strong>
                        <span>Toque para ver o status</span>
                    </div>
                </div>
                <span class="cta-pedido-ativo-seta">‚Ä∫</span>
            </div>
        }

        <!-- ========== FOOTER NAVEGA√á√ÉO ========== -->
        <app-cardapio-footer-nav
            [abaAtual]="abaAtual()"
            [totalCarrinho]="carrinho.totalItens()"
            (abaMudou)="navegarPara($event)"
            (abrirCarrinho)="navegarPara('carrinho')"
        />
    }

    <!-- ========== ETAPA 4: SUCESSO ========== -->
    @if (etapaAtual() === 'sucesso') {
        <app-sucesso-screen
            [sucesso]="sucesso"
            [mesaNumero]="mesa()?.numero"
            (continuarNavegando)="continuarNavegando()"
            (novoPedido)="novoPedido()"
        />
    }

    <!-- ========== MODAL: CARRINHO ========== -->
    @if (carrinho.mostrarCarrinho()) {
        <div class="modal-overlay carrinho-overlay" (click)="fecharCarrinho()">
            <div class="modal-carrinho" (click)="$event.stopPropagation()">
                <div class="carrinho-header">
                    @if (pagamento.etapa() === 'itens') {
                        <h2>Seu Pedido</h2>
                    } @else if (pagamento.etapa() === 'pagamento') {
                        <button class="btn-voltar-carrinho" (click)="pagamento.voltarParaItens()">‚Üê</button>
                        <h2>Pagamento</h2>
                    } @else if (pagamento.etapa() === 'confirmacao') {
                        <button class="btn-voltar-carrinho" (click)="pagamento.voltarParaPagamento()">‚Üê</button>
                        <h2>Confirmar</h2>
                    }
                    <button class="btn-fechar-modal" (click)="fecharCarrinho()">√ó</button>
                </div>

                <!-- ========== ETAPA 1: ITENS ========== -->
                @if (pagamento.etapa() === 'itens') {
                <div class="carrinho-content">
                    @if (carrinho.itens().length === 0) {
                        <div class="carrinho-vazio">
                            <span>üõí</span>
                            <p>Seu carrinho est√° vazio</p>
                        </div>
                    } @else {
                        <!-- Info do cliente -->
                        @if (identificacao.clienteIdentificado()) {
                            <div class="carrinho-cliente-info">
                                @if (identificacao.clienteIdentificado()!.fotoUrl) {
                                    <img
                                        [src]="getFotoUrlComProxy(identificacao.clienteIdentificado()!.fotoUrl) || ''"
                                        alt="Foto do cliente"
                                        class="cliente-foto"
                                    />
                                } @else {
                                    <span class="cliente-icone">üë§</span>
                                }
                                <div class="cliente-dados">
                                    <strong>{{ identificacao.clienteIdentificado()!.nome }}</strong>
                                    <span>{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</span>
                                </div>
                            </div>
                        }

                        <div class="carrinho-itens">
                            @for (item of carrinho.itens(); track item.produto.id) {
                                <div class="carrinho-item">
                                    <div class="item-info">
                                        <h4>{{ item.produto.nome }}</h4>
                                        @if (item.adicionais && item.adicionais.length > 0) {
                                            <div class="item-adicionais">
                                                @for (ad of item.adicionais; track ad.adicional.id) {
                                                    <span class="item-adicional-tag">
                                                        +{{ ad.quantidade }}x {{ ad.adicional.nome }}
                                                    </span>
                                                }
                                            </div>
                                        }
                                        @if (item.observacao) {
                                            <p class="item-obs">{{ item.observacao }}</p>
                                        }
                                        <span class="item-preco">{{ formatarPrecoItemCarrinho(item) }}</span>
                                    </div>
                                    <div class="item-controles">
                                        <button class="btn-qty-mini" (click)="carrinho.alterarQuantidade(item.produto.id, -1)">‚àí</button>
                                        <span class="qty-mini">{{ item.quantidade }}</span>
                                        <button class="btn-qty-mini" (click)="carrinho.alterarQuantidade(item.produto.id, 1)">+</button>
                                    </div>
                                    <button class="btn-remover" (click)="carrinho.removerDoCarrinho(item.produto.id)">üóëÔ∏è</button>
                                </div>
                            }
                        </div>

                        <div class="carrinho-total">
                            <span>Total</span>
                            <strong>{{ formatarPreco(carrinho.totalValor()) }}</strong>
                        </div>
                    }
                </div>

                <div class="carrinho-footer">
                    <button
                        class="btn-enviar-pedido"
                        [disabled]="!podeEnviarPedido()"
                        (click)="pagamento.avancarParaPagamento()">
                        Escolher Pagamento
                    </button>
                </div>
                }

                <!-- ========== ETAPA 2: PAGAMENTO ========== -->
                @if (pagamento.etapa() === 'pagamento') {
                <div class="carrinho-content pagamento-content">
                    <div class="pagamento-total-header">
                        <span>Total a pagar</span>
                        <strong>{{ formatarPreco(carrinho.totalValor()) }}</strong>
                    </div>

                    <!-- Toggle para dividir pagamento -->
                    <div class="pagamento-dividir">
                        <label class="toggle-dividir">
                            <input type="checkbox" [checked]="pagamento.dividido()" (change)="pagamento.toggleDividido()">
                            <span class="toggle-slider"></span>
                            <span class="toggle-label">Dividir pagamento</span>
                        </label>
                    </div>

                    <!-- Op√ß√µes de pagamento -->
                    <div class="pagamento-opcoes">
                        <h3>Como deseja pagar?</h3>

                        <!-- PIX -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('PIX')"
                             (click)="pagamento.selecionarMeio('PIX')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üì±</span>
                                <span class="opcao-nome">PIX</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('PIX')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('PIX')"
                                           (input)="pagamento.atualizarValorMeio('PIX', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('PIX')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Cart√£o de Cr√©dito -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')"
                             (click)="pagamento.selecionarMeio('CARTAO_CREDITO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üí≥</span>
                                <span class="opcao-nome">Cart√£o de Cr√©dito</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('CARTAO_CREDITO')"
                                           (input)="pagamento.atualizarValorMeio('CARTAO_CREDITO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_CREDITO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Cart√£o de D√©bito -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')"
                             (click)="pagamento.selecionarMeio('CARTAO_DEBITO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üí≥</span>
                                <span class="opcao-nome">Cart√£o de D√©bito</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('CARTAO_DEBITO')"
                                           (input)="pagamento.atualizarValorMeio('CARTAO_DEBITO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('CARTAO_DEBITO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Dinheiro -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('DINHEIRO')"
                             (click)="pagamento.selecionarMeio('DINHEIRO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üíµ</span>
                                <span class="opcao-nome">Dinheiro</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('DINHEIRO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('DINHEIRO')"
                                           (input)="pagamento.atualizarValorMeio('DINHEIRO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('DINHEIRO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>

                        <!-- Voucher (Vale Refei√ß√£o) -->
                        <div class="pagamento-opcao"
                             [class.selecionado]="pagamento.meioPagamentoSelecionado('VALE_REFEICAO')"
                             (click)="pagamento.selecionarMeio('VALE_REFEICAO')">
                            <div class="opcao-info">
                                <span class="opcao-icone">üé´</span>
                                <span class="opcao-nome">Voucher</span>
                            </div>
                            @if (pagamento.dividido() && pagamento.meioPagamentoSelecionado('VALE_REFEICAO')) {
                                <div class="opcao-valor" (click)="$event.stopPropagation()">
                                    <span>R$</span>
                                    <input type="number"
                                           [value]="pagamento.getValorMeio('VALE_REFEICAO')"
                                           (input)="pagamento.atualizarValorMeio('VALE_REFEICAO', $any($event.target).valueAsNumber || 0)"
                                           min="0"
                                           step="0.01">
                                </div>
                            }
                            @if (!pagamento.dividido() && pagamento.meioPagamentoSelecionado('VALE_REFEICAO')) {
                                <span class="opcao-check">‚úì</span>
                            }
                        </div>
                    </div>

                    <!-- Resumo do pagamento dividido -->
                    @if (pagamento.dividido() && pagamento.meiosSelecionados().length > 0) {
                        <div class="pagamento-resumo">
                            <div class="resumo-linha">
                                <span>Total alocado</span>
                                <span [class.valor-ok]="pagamento.pagamentoValido()" [class.valor-erro]="!pagamento.pagamentoValido()">
                                    {{ formatarPreco(pagamento.totalAlocado()) }}
                                </span>
                            </div>
                            @if (pagamento.valorRestante() > 0.01) {
                                <div class="resumo-linha restante">
                                    <span>Falta alocar</span>
                                    <span class="valor-erro">{{ formatarPreco(pagamento.valorRestante()) }}</span>
                                </div>
                            }
                            @if (pagamento.valorRestante() < -0.01) {
                                <div class="resumo-linha excedente">
                                    <span>Valor excedente</span>
                                    <span class="valor-erro">{{ formatarPreco(Math.abs(pagamento.valorRestante())) }}</span>
                                </div>
                            }
                        </div>
                    }
                </div>

                <div class="carrinho-footer">
                    <button
                        class="btn-enviar-pedido"
                        [disabled]="!pagamento.pagamentoValido()"
                        (click)="pagamento.irParaConfirmacao()">
                        Revisar Pedido
                    </button>
                </div>
                }

                <!-- ========== ETAPA 3: CONFIRMA√á√ÉO ========== -->
                @if (pagamento.etapa() === 'confirmacao') {
                <div class="carrinho-content confirmacao-content">
                    <div class="confirmacao-header">
                        <span class="confirmacao-icone">üìã</span>
                        <h3 class="confirmacao-titulo">Revise seu pedido</h3>
                        <p class="confirmacao-subtitulo">Confira os detalhes antes de enviar</p>
                    </div>

                    <div class="resumo-pedido">
                        <!-- Cliente -->
                        @if (identificacao.clienteIdentificado()) {
                            <div class="resumo-secao">
                                <span class="resumo-secao-titulo">Cliente</span>
                                <div class="resumo-cliente-info">
                                    <span class="cliente-nome-resumo">{{ identificacao.clienteIdentificado()!.nome }}</span>
                                    <span class="cliente-telefone-resumo">{{ formatarTelefone(identificacao.clienteIdentificado()!.telefone) }}</span>
                                </div>
                            </div>
                        }

                        <!-- Itens -->
                        <div class="resumo-secao">
                            <span class="resumo-secao-titulo">Itens ({{ carrinho.itens().length }})</span>
                            @for (item of carrinho.itens(); track item.produto.id) {
                                <div class="resumo-item-pedido">
                                    <div class="item-qtd-nome">
                                        <span class="item-qtd-badge">{{ item.quantidade }}x</span>
                                        <span class="item-nome-resumo">{{ item.produto.nome }}</span>
                                    </div>
                                    <span class="item-valor-resumo">{{ formatarPreco(item.produto.preco * item.quantidade) }}</span>
                                </div>
                            }
                        </div>

                        <!-- Pagamento -->
                        <div class="resumo-secao">
                            <span class="resumo-secao-titulo">Pagamento</span>
                            @for (pag of pagamento.meiosSelecionados(); track pag.tipo) {
                                <div class="resumo-pagamento-item">
                                    <span class="pagamento-metodo">
                                        <span>{{ pagamento.getIconeMeio(pag.tipo) }}</span>
                                        <span>{{ pagamento.getNomeMeio(pag.tipo) }}</span>
                                    </span>
                                    <span class="pagamento-valor-resumo">{{ formatarPreco(pag.valor) }}</span>
                                </div>
                            }
                        </div>

                        <!-- Total -->
                        <div class="resumo-total-final">
                            <span class="total-label">Total</span>
                            <span class="total-valor-final">{{ formatarPreco(carrinho.totalValor()) }}</span>
                        </div>
                    </div>
                </div>

                <div class="carrinho-footer confirmacao-footer">
                    <button class="btn-editar-pedido" (click)="pagamento.voltarParaPagamento()">
                        ‚úèÔ∏è Editar
                    </button>
                    <button
                        class="btn-enviar-pedido btn-confirmar-final"
                        [disabled]="enviando()"
                        (click)="enviarPedido()">
                        @if (enviando()) {
                            Enviando...
                        } @else {
                            ‚úì Confirmar Pedido
                        }
                    </button>
                </div>
                }
            </div>
        </div>
    }

    <!-- ========== CHAT IA - Bot√£o flutuante e Chat fullscreen ========== -->
    @if (etapaAtual() === 'cardapio' && !chatIA.isOpen()) {
        <app-chat-ia-button
            [pulse]="true"
            (onClick)="chatIA.abrirChat()" />
    }

    <app-chat-ia-fullscreen
        [isOpen]="chatIA.isOpen()"
        [isHidden]="carrinho.mostrarDetalhes() || carrinhoAbertoPeloChat()"
        [isLoading]="chatIA.isLoading()"
        [inputText]="chatIA.inputText()"
        [canSend]="chatIA.canSend()"
        [mensagens]="chatIA.mensagens()"
        [quantidadeItensCarrinho]="carrinho.totalItens()"
        [animarCarrinho]="animarCarrinhoChat()"
        [historicoConversas]="chatIA.historicoConversas()"
        [mostrarHistorico]="chatIA.mostrarHistorico()"
        (onClose)="chatIA.fecharChat()"
        (onSend)="chatIA.enviarMensagem()"
        (onInputChange)="chatIA.setInputText($event)"
        (onNovaConversa)="chatIA.novaConversa()"
        (onAdicionarProduto)="adicionarProdutoChatAoCarrinho($event)"
        (onAbrirCarrinho)="abrirCarrinhoNoChat()"
        (onToggleHistorico)="chatIA.toggleHistorico()"
        (onCarregarConversa)="chatIA.carregarConversaDoHistorico($event)"
        (onRemoverConversa)="chatIA.removerDoHistorico($event)" />

    <!-- ========== MODAIS - Renderizados por √∫ltimo para ficar acima do chat ========== -->
    <!-- Modal de detalhes do produto -->
    @if (carrinho.mostrarDetalhes() && carrinho.produtoSelecionado()) {
        <div class="modal-overlay modal-detalhes" (click)="carrinho.fecharDetalhes()">
            <div class="modal-produto" (click)="$event.stopPropagation()">
                <button class="btn-fechar-modal" (click)="carrinho.fecharDetalhes()">√ó</button>

                @if (carrinho.produtoSelecionado()!.foto) {
                    <div class="modal-produto-imagem">
                        <img [src]="carrinho.produtoSelecionado()!.foto" [alt]="carrinho.produtoSelecionado()!.nome">
                    </div>
                }

                <div class="modal-produto-content">
                    <h2>{{ carrinho.produtoSelecionado()!.nome }}</h2>
                    @if (carrinho.produtoSelecionado()!.descricao) {
                        <p class="modal-descricao">{{ carrinho.produtoSelecionado()!.descricao }}</p>
                    }
                    <div class="modal-preco">{{ formatarPreco(carrinho.produtoSelecionado()!.preco) }}</div>

                    <!-- Se√ß√£o de Adicionais - Colaps√°vel -->
                    @if (carrinho.carregandoAdicionais()) {
                        <div class="adicionais-loading">
                            <span class="spinner-adicionais"></span>
                            <span>Carregando adicionais...</span>
                        </div>
                    } @else if (carrinho.adicionaisDisponiveis().length > 0) {
                        <div class="adicionais-secao">
                            <button
                                class="btn-expandir-adicionais"
                                [class.expandido]="carrinho.adicionaisExpandido()"
                                (click)="carrinho.toggleAdicionaisExpandido()"
                            >
                                <span class="adicionais-titulo">üçï Adicionais ({{ carrinho.adicionaisDisponiveis().length }})</span>
                                @if (carrinho.adicionaisSelecionados().length > 0) {
                                    <span class="adicionais-badge">{{ carrinho.adicionaisSelecionados().length }} selecionado(s)</span>
                                }
                                <span class="expandir-icone">{{ carrinho.adicionaisExpandido() ? '‚ñ≤' : '‚ñº' }}</span>
                            </button>

                            @if (carrinho.adicionaisExpandido()) {
                                <div class="adicionais-lista">
                                    @for (adicional of carrinho.adicionaisDisponiveis(); track adicional.id) {
                                        <div
                                            class="adicional-item"
                                            [class.selecionado]="carrinho.isAdicionalSelecionado(adicional.id)"
                                            (click)="carrinho.toggleAdicional(adicional)"
                                        >
                                            <div class="adicional-info">
                                                <span class="adicional-nome">{{ adicional.nome }}</span>
                                                <span class="adicional-preco">+ {{ formatarPreco(adicional.preco) }}</span>
                                            </div>
                                            @if (carrinho.isAdicionalSelecionado(adicional.id)) {
                                                <div class="adicional-quantidade" (click)="$event.stopPropagation()">
                                                    <button
                                                        class="btn-adicional-qtd"
                                                        (click)="carrinho.decrementarAdicional(adicional.id)"
                                                    >‚àí</button>
                                                    <span class="adicional-qtd-valor">{{ carrinho.getQuantidadeAdicional(adicional.id) }}</span>
                                                    <button
                                                        class="btn-adicional-qtd"
                                                        (click)="carrinho.incrementarAdicional(adicional.id)"
                                                    >+</button>
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            }
                            @if (carrinho.subtotalAdicionais() > 0) {
                                <div class="adicionais-subtotal">
                                    Adicionais: {{ formatarPreco(carrinho.subtotalAdicionais()) }}
                                </div>
                            }
                        </div>
                    }

                    <div class="observacao-container">
                        <label>Alguma observa√ß√£o?</label>
                        <textarea
                            [(ngModel)]="observacaoTempValue"
                            placeholder="Ex: Sem cebola, bem passado..."
                            rows="2">
                        </textarea>
                    </div>

                    <div class="quantidade-controle">
                        <button class="btn-quantidade" (click)="carrinho.decrementarQuantidade()" [disabled]="carrinho.quantidadeTemp() <= 1">‚àí</button>
                        <span class="quantidade-valor">{{ carrinho.quantidadeTemp() }}</span>
                        <button class="btn-quantidade" (click)="carrinho.incrementarQuantidade()">+</button>
                    </div>

                    <button class="btn-adicionar-carrinho" (click)="carrinho.adicionarAoCarrinho()">
                        Adicionar ‚Ä¢ {{ formatarPreco(carrinho.precoTotalItemModal()) }}
                    </button>
                </div>
            </div>
        </div>
    }
</div>
