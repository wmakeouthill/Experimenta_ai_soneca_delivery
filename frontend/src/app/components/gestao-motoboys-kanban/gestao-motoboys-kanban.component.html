<div class="kanban-container">
  <header class="kanban-header">
    <div class="header-content">
      <h1 class="kanban-titulo">
        <img src="/assets/experimenta_ai_banner_circular.png" alt="Experimenta a√≠" class="kanban-logo" />
        Gest√£o de Motoboys
      </h1>

      <div class="header-info">
        @if (temSessaoAtiva()) {
          <div class="sessao-info">
            <span class="sessao-label">Sess√£o:</span>
            <span class="sessao-nome">{{ sessaoAtiva()!.nome }}</span>
            <span class="sessao-status sessao-aberta-badge">‚óè ABERTA</span>
          </div>
        } @else {
          <div class="sessao-info sessao-sem-sessao">
            <span class="sessao-label">‚ö†Ô∏è Sem sess√£o</span>
            <a routerLink="/sessoes" class="sessao-link-criar">Criar</a>
          </div>
        }

        <div class="total-entregas">
          <span class="total-label">Total de Entregas:</span>
          <span class="total-value">{{ totalEntregas() }}</span>
        </div>
      </div>

      <div class="header-actions">
        <button class="btn-voltar" routerLink="/" aria-label="Voltar para home">
          ‚Üê Voltar
        </button>
      </div>
    </div>
  </header>

  @if (erro()) {
    <div class="erro-mensagem">
      <p>{{ erro() }}</p>
      <button class="btn-recarregar" (click)="carregarSessaoAtiva()">
        Tentar novamente
      </button>
    </div>
  }

  @if (estaCarregando() && pedidos().length === 0) {
    <div class="estado-carregando">
      <div class="spinner"></div>
      <p>Carregando entregas...</p>
    </div>
  }

  @if (!temSessaoAtiva()) {
    <div class="sem-sessao">
      <p>N√£o h√° sess√£o de trabalho ativa.</p>
      <a routerLink="/sessoes" class="btn-primary">Criar Sess√£o</a>
    </div>
  } @else if (colunasKanban().length === 0) {
    <div class="sem-motoboys">
      <p>N√£o h√° motoboys ativos cadastrados.</p>
      <a routerLink="/gestao-motoboys" class="btn-primary">Gerenciar Motoboys</a>
    </div>
  } @else if (totalEntregas() === 0) {
    <div class="sem-entregas">
      <p>N√£o h√° entregas atribu√≠das a motoboys no momento.</p>
    </div>
  } @else {
    <div class="kanban-board">
      @for (coluna of colunasKanban(); track coluna.motoboy.id) {
        <div class="kanban-coluna">
          <div class="coluna-header">
            <div class="motoboy-info">
              <div class="motoboy-linha-principal">
                <div class="motoboy-avatar">üõµ</div>
                <h3 class="motoboy-nome" [title]="coluna.motoboy.nome">{{ coluna.motoboy.apelido || coluna.motoboy.nome }}</h3>
                <div class="coluna-metadados">
                  <div class="coluna-contador">
                    <span class="contador-total">{{ coluna.pedidos.length }}</span>
                  </div>
                  @if (coluna.valorAPagar > 0) {
                    <div class="coluna-valor-pagar-compacto">
                      <span class="valor-label-compacto">A pagar:</span>
                      <span class="valor-total-compacto">{{ formatarValor(coluna.valorAPagar) }}</span>
                    </div>
                  }
                </div>
              </div>
              <div class="motoboy-linha-secundaria">
                @if (coluna.motoboy.telefone) {
                  <span class="motoboy-telefone">üìû {{ formatarTelefone(coluna.motoboy.telefone) }}</span>
                }
                @if (coluna.motoboy.veiculo || coluna.motoboy.placa) {
                  <span class="motoboy-veiculo">
                    {{ coluna.motoboy.veiculo || 'Ve√≠culo' }}@if (coluna.motoboy.placa) { - {{ coluna.motoboy.placa }}}
                  </span>
                }
              </div>
            </div>
          </div>

          <div class="coluna-conteudo">
            <!-- Coluna: PRONTO -->
            @if (coluna.pedidosPorStatus.pronto.length > 0) {
              <div class="status-section">
                <div class="status-header">
                  <h4 class="status-titulo">‚úÖ Pronto</h4>
                  <span class="status-count">{{ coluna.pedidosPorStatus.pronto.length }}</span>
                </div>
                <div class="pedidos-lista">
                  @for (pedido of coluna.pedidosPorStatus.pronto; track pedido.id) {
                    <div
                      class="pedido-card pronto"
                      [class.card-clicavel]="pedido.latitude && pedido.longitude"
                      [attr.role]="pedido.latitude && pedido.longitude ? 'button' : null"
                      [attr.tabindex]="pedido.latitude && pedido.longitude ? 0 : null"
                      (click)="abrirRotaParaEntrega(pedido)"
                      (keydown)="abrirRotaComTeclado($event, pedido)"
                      [title]="pedido.latitude && pedido.longitude ? 'Clique ou pressione Enter para abrir rota no Google Maps' : 'Endere√ßo sem coordenadas - n√£o √© poss√≠vel abrir rota'">
                      <div class="pedido-header">
                        <div class="pedido-numero-wrapper">
                          <span class="pedido-numero">#{{ pedido.numeroPedido }}</span>
                          <span class="pedido-status-badge pronto-badge">‚úÖ Pronto</span>
                        </div>
                        <div class="pedido-cliente-wrapper">
                          <span class="pedido-cliente" [title]="pedido.clienteNome">{{ pedido.clienteNome }}</span>
                        </div>
                      </div>
                      @if (pedido.enderecoEntrega) {
                        <div class="pedido-endereco">
                          üìç {{ pedido.enderecoEntrega }}
                        </div>
                      }
                      <div class="pedido-valores-linha">
                        <div class="pedido-valor-pedido">
                          Pedido: {{ formatarValor(pedido.valorTotal) }}
                        </div>
                        <div class="pedido-valor-entrega">
                        @if (editandoValor() === pedido.id) {
                          <div class="editar-valor-wrapper">
                            <input
                              type="number"
                              class="input-valor-motoboy"
                              [value]="valorEditando()"
                              (input)="valorEditando.set(+$any($event.target).value)"
                              step="0.01"
                              min="0"
                              (keydown.enter)="salvarValorMotoboy(pedido)"
                              (keydown.escape)="cancelarEdicaoValor()"
                              autofocus>
                            <div class="acoes-edicao">
                              <button
                                class="btn-salvar-valor"
                                (click)="$event.stopPropagation(); salvarValorMotoboy(pedido)"
                                title="Salvar">
                                ‚úì
                              </button>
                              <button
                                class="btn-cancelar-valor"
                                (click)="$event.stopPropagation(); cancelarEdicaoValor()"
                                title="Cancelar">
                                ‚úï
                              </button>
                            </div>
                          </div>
                        } @else {
                          <button type="button" class="valor-motoboy-display" (click)="$event.stopPropagation(); iniciarEdicaoValor(pedido)" title="Clique para editar">
                            <span class="valor-motoboy-label">Valor entrega:</span>
                            <span class="valor-motoboy-valor">{{ formatarValor(obterValorMotoboy(pedido)) }}</span>
                            <span class="icone-editar">‚úèÔ∏è</span>
                          </button>
                        }
                        </div>
                      </div>
                      <div class="pedido-acoes">
                        <button
                          class="btn-acao btn-saiu-entrega"
                          (click)="$event.stopPropagation(); marcarComoSaiuParaEntrega(pedido)"
                          title="Marcar como saiu para entrega">
                          üöö Saiu para Entrega
                        </button>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Coluna: SAIU_PARA_ENTREGA -->
            @if (coluna.pedidosPorStatus.saiuParaEntrega.length > 0) {
              <div class="status-section">
                <div class="status-header">
                  <h4 class="status-titulo">üöö Saiu para Entrega</h4>
                  <span class="status-count">{{ coluna.pedidosPorStatus.saiuParaEntrega.length }}</span>
                </div>
                <div class="pedidos-lista">
                  @for (pedido of coluna.pedidosPorStatus.saiuParaEntrega; track pedido.id) {
                    <div
                      class="pedido-card em-entrega"
                      [class.card-clicavel]="pedido.latitude && pedido.longitude"
                      [attr.role]="pedido.latitude && pedido.longitude ? 'button' : null"
                      [attr.tabindex]="pedido.latitude && pedido.longitude ? 0 : null"
                      (click)="abrirRotaParaEntrega(pedido)"
                      (keydown)="abrirRotaComTeclado($event, pedido)"
                      [title]="pedido.latitude && pedido.longitude ? 'Clique ou pressione Enter para abrir rota no Google Maps' : 'Endere√ßo sem coordenadas - n√£o √© poss√≠vel abrir rota'">
                      <div class="pedido-header">
                        <div class="pedido-numero-wrapper">
                          <span class="pedido-numero">#{{ pedido.numeroPedido }}</span>
                          <span class="pedido-status-badge em-entrega-badge">üöö Em tr√¢nsito</span>
                        </div>
                        <div class="pedido-cliente-wrapper">
                          <span class="pedido-cliente" [title]="pedido.clienteNome">{{ pedido.clienteNome }}</span>
                        </div>
                      </div>
                      @if (pedido.enderecoEntrega) {
                        <div class="pedido-endereco">
                          üìç {{ pedido.enderecoEntrega }}
                        </div>
                      }
                      <div class="pedido-valores-linha">
                        <div class="pedido-valor-pedido">
                          Pedido: {{ formatarValor(pedido.valorTotal) }}
                        </div>
                        <div class="pedido-valor-entrega">
                        @if (editandoValor() === pedido.id) {
                          <div class="editar-valor-wrapper">
                            <input
                              type="number"
                              class="input-valor-motoboy"
                              [value]="valorEditando()"
                              (input)="valorEditando.set(+$any($event.target).value)"
                              step="0.01"
                              min="0"
                              (keydown.enter)="salvarValorMotoboy(pedido)"
                              (keydown.escape)="cancelarEdicaoValor()"
                              autofocus>
                            <div class="acoes-edicao">
                              <button
                                class="btn-salvar-valor"
                                (click)="$event.stopPropagation(); salvarValorMotoboy(pedido)"
                                title="Salvar">
                                ‚úì
                              </button>
                              <button
                                class="btn-cancelar-valor"
                                (click)="$event.stopPropagation(); cancelarEdicaoValor()"
                                title="Cancelar">
                                ‚úï
                              </button>
                            </div>
                          </div>
                        } @else {
                          <button type="button" class="valor-motoboy-display" (click)="$event.stopPropagation(); iniciarEdicaoValor(pedido)" title="Clique para editar">
                            <span class="valor-motoboy-label">Valor entrega:</span>
                            <span class="valor-motoboy-valor">{{ formatarValor(obterValorMotoboy(pedido)) }}</span>
                            <span class="icone-editar">‚úèÔ∏è</span>
                          </button>
                        }
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            @if (coluna.pedidos.length === 0) {
              <div class="sem-pedidos">
                <p>Nenhuma entrega atribu√≠da</p>
              </div>
            }
          </div>
        </div>
      }
    </div>
  }
</div>

<!-- Modal de Mapa -->
<app-modal-mapa-entrega
  [aberto]="modalMapaAberto()"
  [latitude]="pedidoSelecionado()?.latitude ?? null"
  [longitude]="pedidoSelecionado()?.longitude ?? null"
  [enderecoEntrega]="pedidoSelecionado()?.enderecoEntrega ?? ''"
  [numeroPedido]="pedidoSelecionado()?.numeroPedido ?? ''"
  (onFechar)="fecharModalMapa()">
</app-modal-mapa-entrega>

