<div class="fila-container">
  <div class="header">
    <h2>
      <span class="icon">ğŸ½ï¸</span>
      Pedidos Aguardando
      @if (quantidade() > 0) {
        <span class="badge">{{ quantidade() }}</span>
      }
    </h2>
    <button class="btn-refresh" (click)="recarregar()" [disabled]="carregando()">
      <span class="icon" [class.spinning]="carregando()">ğŸ”„</span>
    </button>
  </div>

  @if (erro()) {
    <div class="erro-msg">
      <span class="icon">âš ï¸</span>
      {{ erro() }}
      <button class="btn-retry" (click)="recarregar()">Tentar novamente</button>
    </div>
  }

  @if (!temPedidos() && !carregando()) {
    <div class="empty-state">
      <span class="icon-large">âœ…</span>
      <p>Nenhum pedido aguardando</p>
      <small>Os pedidos de mesa e delivery aparecerÃ£o aqui</small>
    </div>
  }

  <div class="pedidos-lista">
    @for (pedido of pedidosPendentes(); track pedido.id) {
      <div class="pedido-card" [class.expandido]="pedidoExpandido() === pedido.id" [class.delivery]="isDelivery(pedido)" [class.retirada]="isRetirada(pedido)">
        <div class="pedido-header" (click)="toggleExpandir(pedido.id)">
          <div class="mesa-info">
            @if (isDelivery(pedido)) {
              <span class="tipo-badge delivery">ğŸï¸ Delivery</span>
            } @else if (isRetirada(pedido)) {
              <span class="tipo-badge retirada">ğŸª Retirada</span>
            } @else {
              <span class="mesa-numero">Mesa {{ pedido.numeroMesa }}</span>
            }
            <span class="cliente-nome">{{ pedido.nomeCliente }}</span>
            @if (pedido.telefoneCliente) {
              <span class="cliente-telefone">ğŸ“ {{ pedido.telefoneCliente }}</span>
            }
          </div>

          <div class="pedido-meta">
            <span class="tempo-espera" [class]="getClasseTempoEspera(pedido.tempoEsperaSegundos)">
              â±ï¸ {{ formatarTempoEspera(pedido.tempoEsperaSegundos) }}
            </span>
            <span class="valor-total">{{ formatarPreco(pedido.valorTotal) }}</span>
          </div>

          <div class="expand-icon">
            {{ pedidoExpandido() === pedido.id ? 'â–²' : 'â–¼' }}
          </div>
        </div>

        @if (pedidoExpandido() === pedido.id) {
          <div class="pedido-detalhes">
            <!-- InformaÃ§Ãµes de Delivery -->
            @if (isDelivery(pedido) && pedido.enderecoEntrega) {
              <div class="delivery-info">
                <h4>ğŸ“ EndereÃ§o de Entrega</h4>
                <p class="endereco">{{ pedido.enderecoEntrega }}</p>
                @if (pedido.previsaoEntregaCliente) {
                  <p class="previsao-cliente">ğŸ• PrevisÃ£o solicitada: {{ pedido.previsaoEntregaCliente }}</p>
                }
              </div>
            }

            @if (isRetirada(pedido)) {
              <div class="retirada-info">
                <h4>ğŸª Retirada no Local</h4>
                <p>Cliente irÃ¡ buscar o pedido</p>
                @if (pedido.previsaoEntregaCliente) {
                  <p class="previsao-cliente">ğŸ• PrevisÃ£o solicitada: {{ pedido.previsaoEntregaCliente }}</p>
                }
              </div>
            }

            <div class="itens-lista">
              <h4>Itens do Pedido</h4>
              @for (item of pedido.itens; track item.produtoId) {
                <div class="item">
                  <div class="item-info">
                    <span class="item-quantidade">{{ item.quantidade }}x</span>
                    <span class="item-nome">{{ item.nomeProduto }}</span>
                  </div>
                  <span class="item-preco">{{ formatarPreco(item.subtotal) }}</span>
                  @if (item.adicionais && item.adicionais.length > 0) {
                    <div class="item-adicionais">
                      @for (ad of item.adicionais; track ad.adicionalId) {
                        <span class="adicional-badge">+{{ ad.quantidade }}x {{ ad.nome }} ({{ formatarPreco(ad.subtotal) }})</span>
                      }
                    </div>
                  }
                  @if (item.observacoes) {
                    <div class="item-obs">ğŸ“ {{ item.observacoes }}</div>
                  }
                </div>
              }
            </div>

            @if (pedido.observacoes) {
              <div class="observacoes">
                <strong>ObservaÃ§Ãµes:</strong>
                <p>{{ pedido.observacoes }}</p>
              </div>
            }

            <div class="acoes">
              <button
                class="btn-aceitar"
                (click)="aceitarOuAbrirModal(pedido); $event.stopPropagation()"
                [disabled]="processando() !== null">
                @if (processando() === pedido.id) {
                  <span class="spinner"></span> Processando...
                } @else {
                  âœ“ Aceitar Pedido
                }
              </button>

              <button
                class="btn-rejeitar"
                (click)="abrirModalRejeicao(pedido); $event.stopPropagation()"
                [disabled]="processando() !== null">
                âœ• Rejeitar
              </button>
            </div>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Modal de RejeiÃ§Ã£o -->
@if (mostrarModalRejeicao()) {
  <div class="modal-overlay" (click)="fecharModalRejeicao()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h3>Rejeitar Pedido</h3>
      <p>Mesa {{ pedidoParaRejeitar()?.numeroMesa }} - {{ pedidoParaRejeitar()?.nomeCliente }}</p>

      <div class="form-group">
        <label for="motivo">Motivo da rejeiÃ§Ã£o (opcional):</label>
        <textarea
          id="motivo"
          [(ngModel)]="motivoRejeicaoTexto"
          placeholder="Ex: Produto indisponÃ­vel, mesa nÃ£o existe..."
          rows="3">
        </textarea>
      </div>      <div class="modal-acoes">
        <button class="btn-cancelar" (click)="fecharModalRejeicao()">Cancelar</button>
        <button class="btn-confirmar-rejeicao" (click)="confirmarRejeicao()">Confirmar RejeiÃ§Ã£o</button>
      </div>
    </div>
  </div>
}

<!-- Modal de Aceitar Delivery/Retirada -->
@if (mostrarModalAceitar()) {
  <div class="modal-overlay" (click)="fecharModalAceitar()">
    <div class="modal-content modal-aceitar" (click)="$event.stopPropagation()">
      <h3>
        @if (isDelivery(pedidoParaAceitar()!)) {
          ğŸï¸ Aceitar Delivery
        } @else {
          ğŸª Aceitar Retirada
        }
      </h3>

      <div class="info-pedido">
        <p><strong>Cliente:</strong> {{ pedidoParaAceitar()?.nomeCliente }}</p>
        @if (pedidoParaAceitar()?.telefoneCliente) {
          <p><strong>Telefone:</strong> {{ pedidoParaAceitar()?.telefoneCliente }}</p>
        }
        <p><strong>Valor:</strong> {{ formatarPreco(pedidoParaAceitar()?.valorTotal || 0) }}</p>
        @if (isDelivery(pedidoParaAceitar()!) && pedidoParaAceitar()?.enderecoEntrega) {
          <p><strong>EndereÃ§o:</strong> {{ pedidoParaAceitar()?.enderecoEntrega }}</p>
        }
        @if (pedidoParaAceitar()?.previsaoEntregaCliente) {
          <p><strong>PrevisÃ£o solicitada:</strong> {{ pedidoParaAceitar()?.previsaoEntregaCliente }}</p>
        }
      </div>

      @if (isDelivery(pedidoParaAceitar()!)) {
        <div class="form-group">
          <label for="motoboy">Motoboy:</label>
          @if (carregandoMotoboys()) {
            <p class="loading-text">Carregando motoboys...</p>
          } @else if (motoboysDisponiveis().length > 0) {
            <select id="motoboy" [(ngModel)]="motoboyIdSelecionado">
              <option value="">Selecione um motoboy (opcional)</option>
              @for (motoboy of motoboysDisponiveis(); track motoboy.id) {
                <option [value]="motoboy.id">
                  {{ motoboy.nome }} {{ motoboy.veiculo ? '- ' + motoboy.veiculo : '' }}
                </option>
              }
            </select>
          } @else {
            <p class="aviso">Nenhum motoboy disponÃ­vel. <a routerLink="/gestao-motoboys">Cadastrar motoboy</a></p>
          }
        </div>

        <div class="form-group">
          <label for="taxa">Taxa de Entrega (R$):</label>
          <input
            type="number"
            id="taxa"
            [(ngModel)]="taxaEntrega"
            placeholder="0.00"
            step="0.01"
            min="0">
        </div>
      }

      <div class="form-group">
        <label for="previsao">PrevisÃ£o de Entrega/Retirada:</label>
        <input
          type="text"
          id="previsao"
          [(ngModel)]="previsaoEntrega"
          placeholder="Ex: 30 minutos, 1 hora">
      </div>

      <div class="modal-acoes">
        <button class="btn-cancelar" (click)="fecharModalAceitar()">Cancelar</button>
        <button class="btn-confirmar-aceitar" (click)="confirmarAceitarDelivery()">
          âœ“ Confirmar e Aceitar
        </button>
      </div>
    </div>
  </div>
}
