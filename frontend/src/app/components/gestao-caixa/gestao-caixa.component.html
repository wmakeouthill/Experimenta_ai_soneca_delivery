<div class="caixa-container">
  <header class="caixa-header">
    <div class="caixa-header-content">
      <h1 class="caixa-titulo">
        <img src="/assets/experimenta_ai_banner_circular.png" alt="Experimenta a√≠" class="caixa-logo" />
        üíµ Gest√£o de Caixa
      </h1>

      <div class="header-right">
        <!-- Cards de Diferen√ßas no Header -->
        @if (resumoCaixa()) {
          <div class="header-diferencas">
            <!-- Diferen√ßa da Sess√£o Atual -->
            @if (resumoCaixa()?.valorFechamento !== null && resumoCaixa()?.valorFechamento !== undefined) {
              <div class="card-diferenca-header" [class.positiva]="(calcularDiferencaAtual()) >= 0" [class.negativa]="(calcularDiferencaAtual()) < 0">
                <span class="card-dif-label">üìä Atual</span>
                <span class="card-dif-valor">{{ formatarMoedaComSinal(calcularDiferencaAtual()) }}</span>
              </div>
            } @else {
              <div class="card-diferenca-header neutro">
                <span class="card-dif-label">üìä Atual</span>
                <span class="card-dif-valor">-</span>
              </div>
            }

            <!-- Diferen√ßa da Sess√£o Anterior -->
            @if (resumoCaixa()?.diferencaSessaoAnterior !== null && resumoCaixa()?.diferencaSessaoAnterior !== undefined) {
              <div class="card-diferenca-header" [class.positiva]="(resumoCaixa()?.diferencaSessaoAnterior ?? 0) >= 0" [class.negativa]="(resumoCaixa()?.diferencaSessaoAnterior ?? 0) < 0">
                <span class="card-dif-label">‚èÆÔ∏è Anterior</span>
                <span class="card-dif-valor">{{ formatarMoedaComSinal(resumoCaixa()?.diferencaSessaoAnterior) }}</span>
              </div>
            } @else {
              <div class="card-diferenca-header neutro">
                <span class="card-dif-label">‚èÆÔ∏è Anterior</span>
                <span class="card-dif-valor">-</span>
              </div>
            }

            <!-- Diferen√ßa Global -->
            <div class="card-diferenca-header card-global" [class.positiva]="(resumoCaixa()?.diferencaGlobal ?? 0) >= 0" [class.negativa]="(resumoCaixa()?.diferencaGlobal ?? 0) < 0">
              <span class="card-dif-label">üåç Global</span>
              <span class="card-dif-valor">{{ formatarMoedaComSinal(resumoCaixa()?.diferencaGlobal) }}</span>
            </div>
          </div>
        }

        <div class="header-actions">
          <button class="btn-voltar" routerLink="/" aria-label="Voltar para home">
            ‚Üê Voltar
          </button>
        </div>
      </div>
    </div>
  </header>

  <div class="caixa-layout">
    <!-- Sidebar de Sess√µes -->
    <aside class="sidebar-sessoes">
      <div class="sessoes-container">
        <h2 class="sessoes-titulo">üìÖ Sess√µes</h2>

        @if (estaCarregando() && sessoes().length === 0) {
          <div class="estado-carregando-sidebar">
            <div class="spinner-small"></div>
            <p>Carregando...</p>
          </div>
        }

        @if (estado() === 'erro' && sessoes().length === 0) {
          <div class="estado-erro-sidebar">
            <p>{{ erro() }}</p>
            <button class="btn-recarregar-small" (click)="recarregar()">Tentar novamente</button>
          </div>
        }

        @if (sessoes().length === 0 && estado() === 'sucesso') {
          <div class="estado-vazio-sidebar">
            <p>Nenhuma sess√£o encontrada.</p>
          </div>
        }

        <div class="sessoes-lista">
          @for (sessao of sessoes(); track sessao.id) {
            <button
              class="sessao-item"
              [class.sessao-selecionada]="sessaoSelecionada()?.id === sessao.id"
              [class.sessao-aberta]="sessao.status === StatusSessao.ABERTA"
              [class.sessao-pausada]="sessao.status === StatusSessao.PAUSADA"
              [class.sessao-finalizada]="sessao.status === StatusSessao.FINALIZADA"
              (click)="selecionarSessao(sessao)"
            >
              <div class="sessao-item-info">
                <span class="sessao-item-nome">{{ sessao.nome }}</span>
              </div>
              <span class="sessao-item-status" [class]="'status-' + sessao.status.toLowerCase()">
                {{ sessao.status }}
              </span>
            </button>
          }
        </div>
      </div>
    </aside>

    <!-- Conte√∫do Principal -->
    <main class="caixa-main">
      @if (!temSessaoSelecionada()) {
        <div class="estado-inicial">
          <div class="estado-inicial-icone">üí∞</div>
          <h2>Selecione uma Sess√£o</h2>
          <p>Escolha uma sess√£o de trabalho na lista ao lado para visualizar os dados do caixa.</p>
        </div>
      }

      @if (temSessaoSelecionada() && estaCarregando()) {
        <div class="estado-carregando">
          <div class="spinner"></div>
          <p>Carregando dados do caixa...</p>
        </div>
      }

      @if (temSessaoSelecionada() && estado() === 'erro') {
        <div class="estado-erro">
          <p class="erro-mensagem">{{ erro() }}</p>
          <button class="btn-recarregar" (click)="recarregar()">Tentar novamente</button>
        </div>
      }

      @if (temSessaoSelecionada() && estado() === 'sucesso' && resumoCaixa()) {
        <!-- Header Compacto da Sess√£o -->
        <div class="sessao-header-compacto">
          <div class="sessao-info-compacto">
            <span class="sessao-nome-compacto">{{ resumoCaixa()?.nomeSessao }}</span>
            <span class="sessao-status-compacto" [class]="'status-' + sessaoSelecionada()?.status?.toLowerCase()">
              {{ sessaoSelecionada()?.status }}
            </span>
          </div>
          <button class="btn-limpar-compacto" (click)="limparSelecao()">‚úï</button>
        </div>

        <!-- Cards de Resumo Compactos -->
        <div class="resumo-cards-compacto">
          <div class="card-compacto card-abertura">
            <span class="card-label-compacto">üîì Abertura</span>
            <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.valorAbertura) }}</span>
          </div>

          <div class="card-compacto card-vendas">
            <span class="card-label-compacto">üíµ Vendas ({{ resumoCaixa()?.quantidadeVendasDinheiro }})</span>
            <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.totalVendasDinheiro) }}</span>
          </div>

          <div class="card-compacto card-suprimentos">
            <span class="card-label-compacto">üì• Suprimentos</span>
            <span class="card-valor-compacto valor-positivo">+{{ formatarMoeda(resumoCaixa()?.totalSuprimentos) }}</span>
          </div>

          <div class="card-compacto card-sangrias">
            <span class="card-label-compacto">üì§ Sangrias</span>
            <span class="card-valor-compacto valor-negativo">-{{ formatarMoeda(resumoCaixa()?.totalSangrias) }}</span>
          </div>

          <div class="card-compacto card-esperado">
            <span class="card-label-compacto">üéØ Saldo Esperado</span>
            <span class="card-valor-compacto">{{ formatarMoeda(calcularSaldoEsperado()) }}</span>
          </div>

          @if (resumoCaixa()?.valorFechamento !== null && resumoCaixa()?.valorFechamento !== undefined) {
            <div class="card-compacto card-fechamento">
              <span class="card-label-compacto">üîí Fechamento</span>
              <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.valorFechamento) }}</span>
            </div>

            <div class="card-compacto card-diferenca" [class.diferenca-positiva]="(resumoCaixa()?.diferenca ?? 0) >= 0" [class.diferenca-negativa]="(resumoCaixa()?.diferenca ?? 0) < 0">
              <span class="card-label-compacto">üìä Diferen√ßa</span>
              <span class="card-valor-compacto">{{ formatarMoeda(resumoCaixa()?.diferenca) }}</span>
            </div>
          }
        </div>

        <!-- A√ß√µes do Caixa -->
        @if (sessaoEstaAberta()) {
          <div class="caixa-acoes-compacto">
            <button class="btn-acao-compacto btn-sangria" (click)="abrirModalSangria()">
              üì§ Sangria
            </button>
            <button class="btn-acao-compacto btn-suprimento" (click)="abrirModalSuprimento()">
              üì• Suprimento
            </button>
            <button class="btn-acao-compacto btn-estatisticas" (click)="estatisticasComposable.abrirModal()">
              üìä Estat√≠sticas
            </button>
          </div>
        }

        @if (!sessaoEstaAberta() && temSessaoSelecionada()) {
          <div class="caixa-acoes-compacto">
            <button class="btn-acao-compacto btn-estatisticas" (click)="estatisticasComposable.abrirModal()">
              üìä Estat√≠sticas
            </button>
          </div>
        }

        <!-- Tabela de Movimenta√ß√µes (estilo relat√≥rio financeiro) -->
        <section #tabelaCaixa class="tabela-caixa-section">
          <h2 class="tabela-titulo">Movimenta√ß√µes em Dinheiro</h2>

          @if (itensPaginados().totalItens === 0) {
            <div class="tabela-vazia">
              <p>Nenhuma movimenta√ß√£o em dinheiro registrada nesta sess√£o.</p>
            </div>
          }

          @if (itensPaginados().totalItens > 0) {
            <div class="tabela-wrapper">
              <table class="tabela tabela-caixa">
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Descri√ß√£o</th>
                    <th>Usu√°rio</th>
                    <th>Data/Hora</th>
                    <th class="text-right">Valor</th>
                  </tr>
                </thead>
                <tbody>
                  @for (item of itensPaginados().itens; track item.id) {
                    <tr [class]="obterClasseTipo(item.tipo)">
                      <td>
                        <span class="badge-tipo" [class]="'badge-' + item.tipo.toLowerCase()">
                          {{ item.tipoDescricao }}
                        </span>
                      </td>
                      <td>
                        @if (item.tipo === TipoItemCaixa.VENDA_DINHEIRO) {
                          <span class="item-descricao">
                            <strong>#{{ item.numeroPedido }}</strong> - {{ item.clienteNome }}
                          </span>
                        } @else {
                          <span class="item-descricao">{{ item.descricao || '-' }}</span>
                        }
                      </td>
                      <td>
                        <span class="item-usuario">{{ obterNomeUsuario(item.usuarioId) }}</span>
                      </td>
                      <td>{{ formatarDataHora(item.dataHora) }}</td>
                      <td class="text-right">
                        <span class="item-valor" [class.valor-positivo]="item.valor > 0" [class.valor-negativo]="item.valor < 0">
                          {{ item.valor >= 0 ? '+' : '' }}{{ formatarMoeda(item.valor) }}
                        </span>
                      </td>
                    </tr>
                  }
                </tbody>
                <tfoot>
                  <tr class="tabela-total">
                    <td colspan="4"><strong>Total em Dinheiro</strong></td>
                    <td class="text-right"><strong>{{ formatarMoeda(calcularTotalDinheiro()) }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>

            <!-- Pagina√ß√£o -->
            @if (itensPaginados().totalPaginas > 1) {
              <div class="paginacao">
                <button
                  class="btn-paginacao"
                  [disabled]="itensPaginados().paginaAtual === 1"
                  (click)="irParaPagina(itensPaginados().paginaAtual - 1)"
                >
                  ‚Üê Anterior
                </button>

                <div class="paginacao-numeros">
                  @for (pagina of gerarNumerosPagina(); track pagina) {
                    <button
                      class="btn-pagina"
                      [class.active]="pagina === itensPaginados().paginaAtual"
                      [class.disabled]="pagina === '...'"
                      (click)="pagina !== '...' && irParaPagina(+pagina)"
                    >
                      {{ pagina }}
                    </button>
                  }
                </div>

                <button
                  class="btn-paginacao"
                  [disabled]="itensPaginados().paginaAtual === itensPaginados().totalPaginas"
                  (click)="irParaPagina(itensPaginados().paginaAtual + 1)"
                >
                  Pr√≥xima ‚Üí
                </button>
              </div>
            }
          }
        </section>
      }
    </main>
  </div>
</div>

<!-- Modal de Movimenta√ß√£o -->
@if (mostrarModalMovimentacao()) {
  <div class="modal-overlay" (click)="fecharModalMovimentacao()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-titulo">
          {{ tipoMovimentacao() === 'sangria' ? 'üì§ Registrar Sangria' : 'üì• Registrar Suprimento' }}
        </h2>
        <button class="modal-fechar" (click)="fecharModalMovimentacao()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="form-grupo">
          <label class="form-label">Valor *</label>
          <input
            type="number"
            class="form-input"
            placeholder="0,00"
            step="0.01"
            min="0.01"
            [value]="valorMovimentacao()"
            (input)="valorMovimentacao.set(+$any($event.target).value)"
          />
        </div>

        <div class="form-grupo">
          <label class="form-label">Descri√ß√£o *</label>
          <div class="descricao-autocomplete" #descricaoDropdown>
            <div class="input-com-icone">
              <input
                type="text"
                class="form-input input-descricao"
                placeholder="Digite o motivo da movimenta√ß√£o..."
                [value]="descricaoMovimentacao()"
                (input)="onDescricaoInput($any($event.target).value)"
                (focus)="onDescricaoFocus()"
                autocomplete="off"
              />
              <span
                class="icone-dropdown"
                [class.aberto]="sugestoesComposable.mostrarSugestoes()"
                (click)="toggleSugestoes(); $event.stopPropagation()"
              >
                ‚ñº
              </span>
            </div>

            @if (sugestoesComposable.mostrarSugestoes() && sugestoesComposable.todasDescricoes().length > 0) {
              <div class="sugestoes-dropdown">
                <div class="sugestoes-header">
                  <span class="sugestoes-titulo">üìã Descri√ß√µes anteriores</span>
                  <span class="sugestoes-contador">{{ sugestoesComposable.descricoesFiltradas().length }} encontrada(s)</span>
                </div>

                @if (sugestoesComposable.descricoesFiltradas().length > 0) {
                  <ul class="sugestoes-lista">
                    @for (sugestao of sugestoesComposable.descricoesPaginadas(); track sugestao.descricao) {
                      <li
                        class="sugestao-item"
                        [class.sugestao-popular]="sugestao.popular"
                        (click)="selecionarSugestao(sugestao.descricao)"
                      >
                        <span class="sugestao-icone">{{ sugestao.popular ? 'üî•' : '‚Ü©' }}</span>
                        <span class="sugestao-texto">{{ sugestao.descricao }}</span>
                        @if (sugestao.popular) {
                          <span class="sugestao-badge" title="Usada {{ sugestao.quantidade }} vezes">
                            {{ sugestao.quantidade }}x
                          </span>
                        }
                      </li>
                    }
                  </ul>
                } @else {
                  <div class="sugestoes-vazio">
                    <span>üîç Nenhuma descri√ß√£o encontrada para "{{ descricaoMovimentacao() }}"</span>
                  </div>
                }

                @if (sugestoesComposable.totalPaginas() > 1) {
                  <div class="sugestoes-paginacao">
                    <button
                      class="btn-paginar"
                      [disabled]="sugestoesComposable.paginaAtual() <= 1"
                      (click)="sugestoesComposable.paginaAnterior(); $event.stopPropagation()"
                      title="P√°gina anterior"
                    >
                      ‚Äπ
                    </button>
                    <span class="pagina-info">
                      {{ sugestoesComposable.paginaAtual() }} de {{ sugestoesComposable.totalPaginas() }}
                    </span>
                    <button
                      class="btn-paginar"
                      [disabled]="!sugestoesComposable.temMaisPaginas()"
                      (click)="sugestoesComposable.proximaPagina(); $event.stopPropagation()"
                      title="Pr√≥xima p√°gina"
                    >
                      ‚Ä∫
                    </button>
                  </div>
                }
              </div>
            }
          </div>
          <small class="form-hint">
            @if (sugestoesComposable.carregando()) {
              <span class="hint-loading">‚è≥ Carregando sugest√µes...</span>
            } @else if (descricaoMovimentacao().trim() && !sugestoesComposable.descricaoExiste()) {
              <span class="hint-nova">‚ú® Nova descri√ß√£o ser√° salva para uso futuro</span>
            } @else if (sugestoesComposable.todasDescricoes().length > 0) {
              <span class="hint-info">üí° Clique na seta ou digite para ver sugest√µes</span>
            }
          </small>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancelar" (click)="fecharModalMovimentacao()">
          Cancelar
        </button>
        <button
          class="btn-confirmar"
          [class.btn-sangria]="tipoMovimentacao() === 'sangria'"
          [class.btn-suprimento]="tipoMovimentacao() === 'suprimento'"
          [disabled]="!formularioMovimentacaoValido()"
          (click)="confirmarMovimentacao()"
        >
          Confirmar
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal de Estat√≠sticas -->
@if (estatisticasComposable.mostrarModal()) {
  <div class="modal-overlay" (click)="estatisticasComposable.fecharModal()">
    <div class="modal-content modal-estatisticas" (click)="$event.stopPropagation()">
      <div class="modal-header modal-header-estatisticas">
        <h2>üìä Estat√≠sticas de Movimenta√ß√µes</h2>
        <button class="btn-fechar-modal" (click)="estatisticasComposable.fecharModal()">‚úï</button>
      </div>

      <div class="modal-body modal-body-estatisticas">
        @if (estatisticasComposable.carregando()) {
          <div class="estatisticas-carregando">
            <div class="spinner"></div>
            <p>Carregando estat√≠sticas...</p>
          </div>
        }

        @if (estatisticasComposable.erro()) {
          <div class="estatisticas-erro">
            <p>{{ estatisticasComposable.erro() }}</p>
            <button class="btn-recarregar" (click)="estatisticasComposable.carregarEstatisticas()">
              Tentar novamente
            </button>
          </div>
        }

        @if (!estatisticasComposable.carregando() && !estatisticasComposable.erro()) {
          <div class="graficos-container">
            <!-- Gr√°fico de Sangrias -->
            <div class="grafico-section grafico-sangrias">
              <div class="grafico-header">
                <h3>üì§ Sangrias (Retiradas)</h3>
                <div class="grafico-totais">
                  <span class="total-qtd">{{ estatisticasComposable.totalSangrias() }} retiradas</span>
                  <span class="total-valor">{{ formatarMoeda(estatisticasComposable.valorTotalSangrias()) }}</span>
                </div>
              </div>

              @if (estatisticasComposable.sangrias().length === 0) {
                <div class="grafico-vazio">
                  <span>üì≠ Nenhuma sangria registrada</span>
                </div>
              } @else {
                <div class="grafico-barras-vertical">
                  @for (item of estatisticasComposable.sangrias(); track item.descricao) {
                    <div class="barra-vertical-item" [title]="item.descricao + ' - ' + item.quantidade + 'x - ' + formatarMoeda(item.valorTotal)">
                      <div class="barra-vertical-container">
                        <div
                          class="barra-vertical barra-sangria"
                          [style.height.%]="estatisticasComposable.calcularLarguraBarra(item.quantidade, estatisticasComposable.maxQuantidadeSangria())"
                        >
                        </div>
                      </div>
                      <div class="barra-vertical-info">
                        <span class="barra-vertical-qtd">{{ item.quantidade }}x</span>
                        <span class="barra-vertical-valor">{{ formatarMoeda(item.valorTotal) }}</span>
                      </div>
                      <div class="barra-vertical-label">
                        {{ item.descricao }}
                      </div>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Gr√°fico de Suprimentos -->
            <div class="grafico-section grafico-suprimentos">
              <div class="grafico-header">
                <h3>üì• Suprimentos (Entradas)</h3>
                <div class="grafico-totais">
                  <span class="total-qtd">{{ estatisticasComposable.totalSuprimentos() }} entradas</span>
                  <span class="total-valor">{{ formatarMoeda(estatisticasComposable.valorTotalSuprimentos()) }}</span>
                </div>
              </div>

              @if (estatisticasComposable.suprimentos().length === 0) {
                <div class="grafico-vazio">
                  <span>üì≠ Nenhum suprimento registrado</span>
                </div>
              } @else {
                <div class="grafico-barras-vertical">
                  @for (item of estatisticasComposable.suprimentos(); track item.descricao) {
                    <div class="barra-vertical-item" [title]="item.descricao + ' - ' + item.quantidade + 'x - ' + formatarMoeda(item.valorTotal)">
                      <div class="barra-vertical-container">
                        <div
                          class="barra-vertical barra-suprimento"
                          [style.height.%]="estatisticasComposable.calcularLarguraBarra(item.quantidade, estatisticasComposable.maxQuantidadeSuprimento())"
                        >
                        </div>
                      </div>
                      <div class="barra-vertical-info">
                        <span class="barra-vertical-qtd">{{ item.quantidade }}x</span>
                        <span class="barra-vertical-valor">{{ formatarMoeda(item.valorTotal) }}</span>
                      </div>
                      <div class="barra-vertical-label">
                        {{ item.descricao }}
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        }
      </div>

      <div class="modal-footer modal-footer-estatisticas">
        <button class="btn-fechar" (click)="estatisticasComposable.fecharModal()">
          Fechar
        </button>
      </div>
    </div>
  </div>
}
